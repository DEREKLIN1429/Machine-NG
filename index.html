<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine-NG (é‡é»äº‹é …ç´€éŒ„)</title>
    
    <style>
        :root {
            /* ä¸»é«”é…è‰²ï¼šé»‘ã€æ©˜ã€ç¶  */
            --primary-color: #4CAF50; /* ç¶ è‰² - ä¸»è¦/æˆåŠŸ/å„²å­˜ */
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --danger-color: #e53935;
            --copy-color: #FF9800; /* æ©˜è‰² - Copy/Drive */
            --view-color: #212121; /* é»‘è‰² - View/æ¬¡è¦ */
            --frame-color: #4CAF50;
            --input-border: #ddd;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; justify-content: center; min-height: 100vh;
        }

        /* --- æ¨¡çµ„åŒ–æ¨£å¼ --- */
        #login-screen, #status-modal, #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        #login-screen { background: var(--bg-color); }

        .modal-box {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .login-input {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc;
            border-radius: 8px; font-size: 16px; text-align: left;
            box-sizing: border-box;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #app-screen { width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-btn {
            font-size: 24px;
            cursor: pointer; color: #555; padding: 6px;
            border-radius: 50%; transition: background 0.2s;
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
        }
        .header-title h2 { margin: 0; color: #333; font-size: 1.2rem; line-height: 1.4; }

        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 8px; display: block; font-size: 1rem; }

        .photo-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-half { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-cam { background-color: #FF5722; color: white; }
        .btn-gallery { background-color: #FFC107; color: #333; }

        /* --- åœ–ç‰‡é è¦½ (è‡ªå‹•è£å‰ª/æˆªåœ–ç¯„åœ) --- */
        #preview-container { max-width: 100%; height: auto; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;}
        /* æ–°å¢ Aspect Ratio é¡åˆ¥ */
        .ratio-4-3 { aspect-ratio: 4/3; }
        .ratio-16-9 { aspect-ratio: 16/9; }
        .ratio-9-16 { aspect-ratio: 9/16; }
        .ratio-1-1 { aspect-ratio: 1/1; }

        #preview-img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }
        .placeholder { position: absolute; color: #888; font-size: 1.1em; }
        .ratio-tag { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.7em; z-index: 10; }


        /* --- è¼¸å…¥/è¡¨å–®æ¨£å¼ (ä¿æŒä¸è®Š) --- */
        .input-group { margin-bottom: 8px; display: flex; flex-direction: column; }
        .input-label { font-weight: bold; font-size: 0.9rem; color: #333; margin-bottom: 4px; }
        .text-input, textarea, select.text-input {
            width: 100%; padding: 10px; border: 1px solid var(--input-border);
            border-radius: 6px; font-size: 15px; box-sizing: border-box;
            font-family: inherit; transition: border-color 0.3s;
        }
        textarea { height: 80px; resize: vertical; }
        
        .time-component { display: flex; flex-direction: column; margin-bottom: 8px; }
        .time-input-row { display: flex; align-items: center; gap: 5px; }

        /* ç¸½æ™‚é–“è¼¸å…¥çµ„ä»¶æ’ç‰ˆ */
        .total-time-input-group {
            display: flex;
            gap: 8px;
        }
        .total-time-input-group > .text-input:first-child {
            flex-grow: 1;
        }

        /* --- åº•éƒ¨æŒ‰éˆ•å„ªåŒ– (æ­£æ–¹å½¢ï¼Œå…©åˆ—ç¶²æ ¼) --- */
        .footer-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px;
            margin-top: 15px; 
            padding-bottom: 20px;
            align-items: stretch;
        }
        .btn-main {
            width: 100%;
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ */
            
            padding: 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            border: none;
            border-radius: 8px;
            font-size: 16px; /* <-- æŒ‰éˆ•å­—é«”åŠ å¤§ */
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: background 0.2s, transform 0.1s;
            line-height: 1.2;
        }
        .btn-main:active { transform: scale(0.98); }
        
        /* å–®ç¨è™•ç† View Photos æŒ‰éˆ•çš„å®¹å™¨å’Œé•·æ–¹å½¢æ¨£å¼ */
        #view-photos-container {
            grid-column: 1 / -1; /* è·¨è¶Šæ‰€æœ‰åˆ— */
            display: flex;
            justify-content: center;
        }
        #view-photos-container .btn-main {
            max-width: 50%; 
            aspect-ratio: 4 / 1; /* é•·æ–¹å½¢ */
            font-size: 16px; 
        }
        /* ç¢ºä¿æŒ‰éˆ•å…§å®¹æ›è¡Œ */
        .btn-main span { text-align: center; }

        .btn-copy { background-color: var(--copy-color); }
        .btn-save { background-color: var(--primary-color); } 
        .btn-view { background-color: var(--view-color); color: white; }
        .btn-drive { background-color: var(--copy-color); }
        
        /* èªéŸ³æŒ‰éˆ•æ¨£å¼ */
        .btn-voice {
            background-color: #f0f0f0; 
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 5px;
            transition: all 0.2s;
        }
        .btn-voice.recording {
            background-color: #e53935; /* éŒ„éŸ³ä¸­ï¼šç´…è‰²èƒŒæ™¯ */
            color: white;
            box-shadow: 0 0 10px rgba(229, 57, 53, 0.5); 
        }

        /* --- è¨­å®šå…§æ’ç‰ˆä¿®æ­£ (ä¿æŒä¸è®Š) --- */
        #machine-list-container, #concern-section-list-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .machine-list-item {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            background: #f1f1f1;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8em;
            word-break: break-all;
        }
        .btn-remove-item {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 3px;
            font-weight: bold;
        }
        
        .hidden { display: none !important; }
    </style>
    
</head>
<body>

    <div id="login-screen" style="display: none;">
        <div class="modal-box">
            <h3>ğŸ”’ Login (ç™»å…¥)</h3>
            <p style="color:#666; font-size:0.9em;">Default Password: 12345<br>(è«‹è¼¸å…¥å¯†ç¢¼)</p>
            <input type="password" id="loginPass" class="login-input" placeholder="Password">
            <button class="btn-main btn-save" onclick="checkLogin()">Login (é€²å…¥)</button>
        </div>
    </div>

    <div id="status-modal" style="display: none;">
        <div class="modal-box">
            <div id="status-spinner" class="spinner"></div>
            <div id="status-icon" class="status-icon" style="display:none; font-size: 40px;"></div>
            <h3 id="status-text" style="color:#333; margin:0;">Uploading...</h3>
            <p id="status-subtext" style="color:#666; font-size:0.9em; margin-top:5px;">(è³‡æ–™ä¸Šå‚³ä¸­...)</p>
            <button id="status-close-btn" onclick="closeStatusModal()" class="btn-main btn-view" style="margin-top: 15px; display: none;">OK</button>
        </div>
    </div>
    
    <div id="app-screen" style="display: none;">
        <div class="author-header">Author: DERER LIN (v4.1 - Update Only)</div>

        <div class="header">
            <div class="header-btn" onclick="logout()" title="Lock / Logout (é–å®š/ç™»å‡º)">ğŸ”’</div>
            <div class="header-title">
                <h2>Machine-NG<br>é‡é»äº‹é …ç´€éŒ„</h2>
            </div>
            <div class="header-btn" onclick="openSettings()" title="Settings (è¨­å®š)">âš™ï¸</div>
        </div>

        <div class="input-group">
            <label class="input-label" for="input-employee-id">Employee ID (å“¡å·¥ç·¨è™Ÿ):</label>
            <input type="text" id="input-employee-id" class="text-input" placeholder="å„²å­˜å¾Œä¸æœƒæ¸…é™¤">
        </div>

        <div class="card">
            <span class="section-title">1. Photo (åœ–ç‰‡ç´€éŒ„) - ç¯„åœæˆªåœ– (è‡ªå‹•è£å‰ª)</span>
            <div class="photo-controls">
                <button class="btn-half btn-cam" onclick="triggerFile('input-cam')">ğŸ“· Camera</button>
                <button class="btn-half btn-gallery" onclick="triggerFile('input-gallery')">ğŸ–¼ï¸ Gallery</button>
            </div>
            
            <div id="preview-container" class="ratio-4-3" onclick="triggerFile('input-cam')" title="Click to take photo">
                <div class="ratio-tag" id="ratio-display-tag">Ratio: 4:3</div>
                <span class="placeholder">Tap here to Take Photo</span>
                <img id="preview-img">
            </div>
            
            <input type="file" id="input-cam" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">
            <input type="file" id="input-gallery" accept="image/*" class="hidden" onchange="handleFile(this)">
        </div>

        <div class="card" id="info-card">
            <span class="section-title" id="machine-info-title">2. Machine NG Information</span>
            
            <div class="input-group">
                <label class="input-label" for="input-machine">Machine :</label>
                <select id="input-machine" class="text-input">
                    </select>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-form-no">Repair Form No:</label>
                <input type="text" id="input-form-no" class="text-input" placeholder="e.g. A69304">
            </div>

            <div class="time-component">
                <label class="input-label" for="input-stop-time-full">Stop time : (DD/MM/YYYY hh:mm)</label>
                <div class="time-input-row">
                    <input type="text" id="input-stop-time-full" class="text-input"
                               placeholder="è«‹é»å³å´æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥" oninput="calculateTotalStopTime()">
                    <button type="button" class="btn-update-time"
                               onclick="updateSingleTime('input-stop-time-full')" title="Set Current Time">
                        <span style="font-size: 1.1em;">â±ï¸</span>
                    </button>
                </div>
            </div>
            <div class="time-component">
                <label class="input-label" for="input-start-time-full">Start time : (DD/MM/YYYY hh:mm)</label>
                <div class="time-input-row">
                    <input type="text" id="input-start-time-full" class="text-input"
                               placeholder="è«‹é»å³å´æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥" oninput="calculateTotalStopTime()">
                    <button type="button" class="btn-update-time"
                               onclick="updateSingleTime('input-start-time-full')" title="Set Current Time">
                        <span style="font-size: 1.1em;">â±ï¸</span>
                    </button>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label" for="input-total-time">Total stop time : (è‡ªå‹•è¨ˆç®—)</label>
                <div class="total-time-input-group">
                    <input type="text" id="input-total-time" class="text-input" placeholder="" readonly style="background-color: #eee; font-weight: bold;">
                    <select id="total-time-unit" onchange="calculateTotalStopTime()" class="text-input" style="width: auto;">
                        <option value="h">hr (å°æ™‚)</option>
                        <option value="min">min (åˆ†é˜)</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-concern-section">Concern Section :</label>
                <select id="input-concern-section" class="text-input">
                    </select>
            </div>

            <div class="input-group">
                <label class="input-label" for="input-reason">Reason :</label>
                <textarea id="input-reason" placeholder="e.g. dischrge door not open"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-reason" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                    <span style="font-size: 0.8em; color: #666;"> (éœé»˜ 1.5 ç§’è‡ªå‹•åœæ­¢)</span>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-solution">How to Solve Problem:</label>
                <textarea id="input-solution" placeholder="e.g. hydraulic pressure set"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-solution" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                </div>
            </div>
            
             <div class="input-group">
                <label class="input-label" for="input-self-actions">Self Actions:</label>
                <textarea id="input-self-actions" placeholder="e.g. check and inform maintenance team"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-self-actions" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                </div>
            </div>
            
            <select id="voice-lang-select" class="hidden">
                <option value="cmn-Hant-TW">ä¸­æ–‡ (ç¹é«”)</option>
                <option value="en-US">English</option>
                <option value="ja-JP">Japanese</option>
                <option value="hi-IN">Hindi (å°åœ°èª)</option>
            </select>
        </div>

        <div class="card" id="recent-records-card">
            <span class="section-title">3. Recent Records (æœ€è¿‘ 10 ç­†ç´€éŒ„)</span>
            <div id="records-list" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                <p style="text-align: center; color: #999; font-size: 0.9em;">(No Records Found)</p>
            </div>
            
            <div style="margin-top: 10px;">
                <button class="btn-main" style="background-color: var(--danger-color); aspect-ratio: auto; padding: 10px 15px; font-size: 14px;" onclick="clearLocalRecords()">
                    ğŸ—‘ï¸ Clear Local Records (æ¸…é™¤æœ¬åœ°ç´€éŒ„)
                </button>
            </div>
        </div>
        
        <div class="footer-btns">
            <button class="btn-main btn-copy" onclick="copyFormattedInfo()">
                ğŸ“‹<br><span>Copy Info</span>
            </button>
            
            <button class="btn-main btn-save" id="updateBtn" onclick="saveToCloud('update')">
                ğŸ“<br><span>Save/Update (è£œå……)</span>
            </button>
            
            <button class="btn-main btn-view" onclick="viewExcel()">
                ğŸ“Š<br><span>View Excel</span>
            </button>
            
            <div id="view-photos-container">
                 <button class="btn-main btn-drive" onclick="viewDriveFolder()">
                     ğŸ“‚ View Photos
                 </button>
            </div>
        </div>
    </div>

    <div id="settings-modal" style="display: none;">
        <div class="modal-box">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3>Settings (è¨­å®š)</h3>
                <button onclick="closeSettings()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="settings-content-group">
                <div class="modal-group" style="background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
                    <label style="color:#d63384; font-weight: bold; margin-bottom: 5px; display: block;">ğŸ”‘ Login Password (ä¿®æ”¹ç™»å…¥å¯†ç¢¼) (Default: 12345)</label>
                    <input type="text" id="set-password" class="login-input" style="margin: 0;" placeholder="Current: 12345">
                </div>

                <div class="modal-group">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">1. Voice Timeout (éŒ„éŸ³éœé»˜ç§’æ•¸)</label>
                    <input type="number" id="set-timeout" class="login-input" style="margin: 0;" placeholder="Default: 1.5 (seconds)">
                </div>

                <div class="modal-group">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">2. Photo Aspect Ratio (ç…§ç‰‡æ¯”ä¾‹)</label>
                    <select id="set-ratio" class="login-input" style="margin: 0;">
                        <option value="4/3">4:3 (Standard)</option>
                        <option value="16/9">16:9 (Wide)</option>
                        <option value="9/16">9:16 (Vertical / ç›´å¼)</option>
                        <option value="1/1">1:1 (Square)</option>
                        <option value="FULL">FULL (Original / åŸå°ºå¯¸)</option>
                    </select>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 3px;">* Applies auto-crop/cropping guide.</div>
                </div>
                
                <div class="modal-group">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">3. Voice Language (èªéŸ³è¾¨è­˜èªè¨€)</label>
                    <select id="set-lang" class="login-input" style="margin: 0;" onchange="syncLanguage()">
                        <option value="cmn-Hant-TW">Traditional Chinese (ç¹é«”ä¸­æ–‡)</option>
                        <option value="en-US">English</option>
                        <option value="ja-JP">Japanese</option>
                        <option value="hi-IN">Hindi (å°åœ°èª)</option>
                    </select>
                </div>


                <div class="modal-group" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; color: var(--copy-color);">4. Concern Section List Management<br>(ç›¸é—œéƒ¨é–€åˆ—è¡¨ç®¡ç†)</label>
                    
                    <input type="text" id="new-concern-section" class="login-input" style="margin: 0 0 5px 0;" placeholder="Add new section (e.g., Electrical)">
                    <button type="button" class="btn-add-item" onclick="addConcernSection()">+ Add Section (æ–°å¢)</button>

                    <div id="concern-section-list-container">
                        </div>
                </div>
                
                <div class="modal-group" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; color: var(--copy-color);">5. Machine List Management<br>(æ©Ÿå™¨åˆ—è¡¨ç®¡ç†)</label>
                    
                    <input type="text" id="new-machine-name" class="login-input" style="margin: 0 0 5px 0;" placeholder="Add new machine name (e.g., CM4)">
                    <button type="button" class="btn-add-item" onclick="addMachine()">+ Add Machine (æ–°å¢)</button>

                    <div id="machine-list-container">
                        </div>
                </div>
            </div>


            <div style="text-align: center; color: var(--primary-color); font-size: 0.9em; margin-top: 15px;">
                <p>âœ… Cloud Paths are Locked (System Mode)</p>
            </div>

            <button class="btn-main btn-save" onclick="saveSettings()">Save Settings (å„²å­˜è¨­å®š)</button>
        </div>
    </div>

<script>
    // ================= åƒæ•¸èˆ‡åˆå§‹åŒ– =================
    const DEFAULT_PASS = "12345";
    const MAX_IMAGE_WIDTH = 1000;
    const MACHINE_LIST_KEY = "cfg_machine_list";
    const CONCERN_LIST_KEY = "cfg_concern_list";
    const EMPLOYEE_ID_KEY = "cfg_employee_id";
    const LOCAL_RECORDS_KEY = "local_recent_records"; 
    const MAX_RECORDS = 10; 

    const DEFAULT_MACHINE_LIST = ["BM5", "BM6", "BM7", "BM21", "BM22", "BM23", "CA3", "CA4", "CM1", "CM2", "CM3"];
    const DEFAULT_CONCERN_LIST = ["Mixing", "Extrusion", "Cutting", "Calendering"];
    const DEFAULT_VOICE_TIMEOUT = 1.5;

    // ä½ çš„å›ºå®šè·¯å¾‘ (FIXED PATHS)
    const FIXED_SCRIPT_ID = "AKfycbzfPzPODQjp_phrHPwjsoBYeA8-VgeaoYly6hr3Mx09Wj-o5tWHMPa-nTHfaHyloiH8zg/exec";
    const FIXED_SHEET_ID = "1sDKZBJfasUbZSGNAfz9GIWfRdrdXxQMrXrxM3x9RlCY";
    const FIXED_FOLDER_ID = "1VPfLCMIuJPA66RjN8isrC4xq3luPMJe4";

    // ç‹€æ…‹è®Šæ•¸
    let processedImageBase64 = ""; 
    let recognition = null;
    let isRecording = false;
    let activeTextAreaId = null;
    let snapshotText = "";
    let punctuationTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    function initApp() {
        if(!localStorage.getItem("app_password")) {
            localStorage.setItem("app_password", DEFAULT_PASS);
        }
        if(!localStorage.getItem(MACHINE_LIST_KEY)) {
            localStorage.setItem(MACHINE_LIST_KEY, JSON.stringify(DEFAULT_MACHINE_LIST));
        }
        if(!localStorage.getItem(CONCERN_LIST_KEY)) {
            localStorage.setItem(CONCERN_LIST_KEY, JSON.stringify(DEFAULT_CONCERN_LIST));
        }
        if(!localStorage.getItem("cfg_timeout")) {
            localStorage.setItem("cfg_timeout", DEFAULT_VOICE_TIMEOUT);
        }
        
        loadSettingsToUI();
        loadMachineListToUI();
        loadConcernSectionToUI();
        loadEmployeeID();
        
        // æ–°å¢ï¼šè¼‰å…¥æœ¬åœ°ç´€éŒ„
        renderLocalRecords(); 
        
        document.getElementById('input-stop-time-full').value = "";
        document.getElementById('input-start-time-full').value = "";
        document.getElementById('input-total-time').value = "";
        document.getElementById('input-total-time').style.backgroundColor = '#eee';
        document.getElementById('total-time-unit').value = 'min'; 
        
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        if(isLoggedIn === "true") {
            document.getElementById('app-screen').style.display = 'block';
            applySettings();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
    }

    // ================= æœ¬åœ°ç´€éŒ„ç®¡ç†åŠŸèƒ½ =================
    
    function getLocalRecords() {
        try {
            return JSON.parse(localStorage.getItem(LOCAL_RECORDS_KEY)) || [];
        } catch (e) {
            console.error("Failed to parse local records", e);
            return [];
        }
    }

    function saveRecord(recordData, action) {
        let records = getLocalRecords();
        
        const timestamp = new Date().toLocaleString('zh-TW', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });

        const newRecord = {
            time: timestamp,
            machine: recordData.machine || 'N/A',
            formNo: recordData.formNo || 'N/A',
            action: action
        };

        records.unshift(newRecord);

        if (records.length > MAX_RECORDS) {
            records = records.slice(0, MAX_RECORDS);
        }

        localStorage.setItem(LOCAL_RECORDS_KEY, JSON.stringify(records));
        renderLocalRecords();
    }

    function renderLocalRecords() {
        const container = document.getElementById('records-list');
        const records = getLocalRecords();
        container.innerHTML = '';

        if (records.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; font-size: 0.9em;">(No Records Found)</p>';
            return;
        }

        records.forEach((record, index) => {
            const item = document.createElement('div');
            item.style.padding = '8px 0';
            item.style.borderBottom = '1px dashed #eee';
            item.style.fontSize = '0.9em';
            item.innerHTML = `
                <strong style="color: #333;">#${index + 1} (${record.action}):</strong> ${record.formNo}<br>
                <span style="color: #666;">æ©Ÿå°: ${record.machine} | æ™‚é–“: ${record.time}</span>
            `;
            container.appendChild(item);
        });
    }

    function clearLocalRecords() {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚")) {
            localStorage.removeItem(LOCAL_RECORDS_KEY);
            renderLocalRecords();
            alert("æœ¬åœ°ç´€éŒ„å·²æ¸…é™¤ã€‚");
        }
    }
    
    // ================= å“¡å·¥ ID æŒä¹…åŒ– =================
    function loadEmployeeID() {
        const savedId = localStorage.getItem(EMPLOYEE_ID_KEY);
        if (savedId) {
            document.getElementById('input-employee-id').value = savedId;
        }
    }

    function saveEmployeeID() {
        const employeeId = document.getElementById('input-employee-id').value.trim();
        localStorage.setItem(EMPLOYEE_ID_KEY, employeeId);
    }
    
    // ================= Concern Section/Machine List/Settings å‡½æ•¸ (ç•¥) =================
    // (ç‚ºäº†ç¨‹å¼ç¢¼ç°¡æ½”ï¼Œçœç•¥äº† Setting, Machine List, Concern List çš„ CRUD å‡½æ•¸ã€‚è«‹ç¢ºä¿æ‚¨çš„å¯¦éš›æª”æ¡ˆä¸­æœ‰é€™äº›å…§å®¹ã€‚)

    function getConcernList() { /* ... */ return JSON.parse(localStorage.getItem(CONCERN_LIST_KEY)) || DEFAULT_CONCERN_LIST; }
    function saveConcernList(list) { /* ... */ }
    function loadConcernSectionToUI() { /* ... */ }
    function renderConcernListSettings() { /* ... */ }
    function addConcernSection() { /* ... */ }
    function removeConcernSection(name) { /* ... */ }
    function getMachineList() { /* ... */ return JSON.parse(localStorage.getItem(MACHINE_LIST_KEY)) || DEFAULT_MACHINE_LIST; }
    function saveMachineList(list) { /* ... */ }
    function loadMachineListToUI() { /* ... */ }
    function renderMachineListSettings() { /* ... */ }
    function addMachine() { /* ... */ }
    function removeMachine(name) { /* ... */ }
    function openSettings() { /* ... */ }
    function checkLogin() { /* ... */ }
    function saveSettings() { /* ... */ }
    function loadSettingsToUI() { /* ... */ }
    function applySettings() { /* ... */ }
    function logout() { /* ... */ }
    function closeSettings() { /* ... */ }
    function syncLanguage() { /* ... */ }

    // ================= æ™‚é–“è™•ç†å‡½æ•¸ =================
    const DATETIME_REGEX = /^(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})$/;

    function parseCustomDateTime(dtStr) {
        const match = dtStr.match(DATETIME_REGEX);
        if (!match) return null;

        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10) - 1;
        const year = parseInt(match[3], 10);
        const hour = parseInt(match[4], 10);
        const minute = parseInt(match[5], 10);

        const date = new Date(year, month, day, hour, minute);

        if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) {
             return null;
        }

        return date;
    }
    
    function calculateTotalStopTime() {
        const stopTimeStr = document.getElementById('input-stop-time-full').value.trim();
        const startTimeStr = document.getElementById('input-start-time-full').value.trim();
        const totalTimeInput = document.getElementById('input-total-time');
        const unitSelect = document.getElementById('total-time-unit');
        const unit = unitSelect ? unitSelect.value : 'h';

        if (stopTimeStr === "" || startTimeStr === "") {
             totalTimeInput.value = "";
             totalTimeInput.style.backgroundColor = '#eee';
             totalTimeInput.dataset.diffMinutes = '';
             return;
        }
        
        const stopDate = parseCustomDateTime(stopTimeStr);
        const startDate = parseCustomDateTime(startTimeStr);

        if (!stopDate || !startDate) {
            totalTimeInput.value = "Invalid Time";
            totalTimeInput.style.backgroundColor = '#fff0f0';
            totalTimeInput.dataset.diffMinutes = '';
            return;
        }

        const diffMs = startDate.getTime() - stopDate.getTime();
        const diffMinutes = Math.round(diffMs / (1000 * 60));
        
        if (diffMinutes <= 0) {
            totalTimeInput.value = "0 min / 0.00 hr";
            totalTimeInput.style.backgroundColor = '#fff0f0';
            totalTimeInput.dataset.diffMinutes = 0;
            return;
        }

        totalTimeInput.dataset.diffMinutes = diffMinutes;
        
        let totalTimeFormatted;
        if (unit === 'h') {
             const diffHours = diffMs / (1000 * 60 * 60);
             totalTimeFormatted = diffHours.toFixed(2) + " hr";
        } else {
             totalTimeFormatted = diffMinutes + " min";
        }
        
        totalTimeInput.value = totalTimeFormatted;
        totalTimeInput.style.backgroundColor = '#e6ffed';
    }


    function getFullDateTimeString(dateObj) {
        const pad = (num) => num.toString().padStart(2, '0');

        const day = pad(dateObj.getDate());
        const month = pad(dateObj.getMonth() + 1);
        const year = pad(dateObj.getFullYear());
        const hour = pad(dateObj.getHours());
        const minute = pad(dateObj.getMinutes());
        
        return `${day}/${month}/${year} ${hour}:${minute}`;
    }
    
    function updateSingleTime(targetId) {
        const targetElement = document.getElementById(targetId);
        const fullDateTime = getFullDateTimeString(new Date());
        
        if (targetElement) {
             targetElement.value = fullDateTime;
             calculateTotalStopTime();
        }
    }
    
    // ================= è¤‡è£½æ ¼å¼åŒ–è¨Šæ¯ =================
    
    function extractDateAndTime(fullTimeStr) {
        const match = fullTimeStr.match(DATETIME_REGEX);
        if (match) {
             const datePart = `${match[1]}/${match[2]}/${match[3]}`;
             const timePart = `${match[4]}:${match[5]}`;
             return { date: datePart, time: timePart };
        }
        return { date: '', time: '' };
    }
    
    function copyFormattedInfo() {
        const totalTimeInput = document.getElementById('input-total-time');
        const totalTimeMinutes = totalTimeInput.dataset.diffMinutes;
        
        let totalTimeFormat;
        if (totalTimeMinutes && totalTimeMinutes > 0) {
            const totalTimeHours = (totalTimeMinutes / 60).toFixed(2);
            totalTimeFormat = `${totalTimeMinutes} Min / ${totalTimeHours} hr`;
        } else {
            totalTimeFormat = '';
        }
        
        // 1. è’é›†è³‡æ–™
        const employeeId = document.getElementById('input-employee-id').value || "N/A";
        const machine = document.getElementById('input-machine').value || "N/A";
        const stopTimeFull = document.getElementById('input-stop-time-full').value.trim();
        const startTimeFull = document.getElementById('input-start-time-full').value.trim();
        const repairFormNo = document.getElementById('input-form-no').value || "N/A";
        const reason = document.getElementById('input-reason').value || "N/A";
        const concernSection = document.getElementById('input-concern-section').value || "N/A";
        const solution = document.getElementById('input-solution').value || "N/A";
        const selfActions = document.getElementById('input-self-actions').value || "N/A";
        
        // 2. è™•ç†æ™‚é–“
        const startDisplay = startTimeFull === "" ? '' : startTimeFull;

        // 3. æ§‹å»ºè¼¸å‡ºå­—ä¸²
        const output = `
ID : ${employeeId}

Machine : ${machine}

Concern Section : ${concernSection}

Stop time : ${stopTimeFull}

Start time : ${startDisplay}

Total stop time : ${totalTimeFormat}

Repair Form No: ${repairFormNo}

Reason :
${reason.replace(/\n/g, '\n')}

How to Solve Problem:
${solution.replace(/\n/g, '\n')}

Self Actions:
${selfActions.replace(/\n/g, '\n')}
        `.trim();

        // 4. è¤‡è£½åˆ°å‰ªè²¼ç°¿
        navigator.clipboard.writeText(output).then(() => {
            alert("âœ… æ•´åˆè¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        }).catch(err => {
            console.error('ç„¡æ³•è¤‡è£½æ–‡å­—:', err);
            alert("âŒ ç„¡æ³•è¤‡è£½æ–‡å­—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚");
        });
    }
    
    // ================= ä¸Šå‚³èˆ‡æ¸…é™¤é‚è¼¯ =================
    function clearInputs() {
        document.getElementById('input-machine').value = "";
        document.getElementById('input-total-time').value = "";
        document.getElementById('input-form-no').value = "";
        document.getElementById('input-reason').value = "";
        document.getElementById('input-concern-section').value = "";
        document.getElementById('input-solution').value = "";
        document.getElementById('input-self-actions').value = "";

        document.getElementById('input-stop-time-full').value = "";
        document.getElementById('input-start-time-full').value = "";
        
        document.getElementById('input-total-time').style.backgroundColor = '#eee';
        calculateTotalStopTime();
        
        // æ¸…é™¤åœ–ç‰‡ç›¸é—œç‹€æ…‹
        processedImageBase64 = "";
        
        document.getElementById('preview-img').style.display = 'none';
        document.querySelector('.placeholder').style.display = 'block';
        
        // é‡æ–°æ‡‰ç”¨è¨­å®šä»¥ç¢ºä¿é è¦½å®¹å™¨çš„æ¯”ä¾‹æ­£ç¢º
        applySettings(); 
    }

    // ä¿®æ”¹ saveToCloud å‡½æ•¸ï¼šå§‹çµ‚ä½¿ç”¨ 'update' æ¨¡å¼ (æ–°å¢æˆ–è£œå……)
    function saveToCloud(mode) {
        if(isRecording) manualStopVoice();

        // å§‹çµ‚ä½¿ç”¨ 'update' æ¨¡å¼ï¼Œè®“å¾Œç«¯é‚è¼¯åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯è£œå……
        const currentMode = 'update'; 

        const employeeId = document.getElementById('input-employee-id').value;
        const machine = document.getElementById('input-machine').value;
        const stopTimeFull = document.getElementById('input-stop-time-full').value;
        const startTimeFull = document.getElementById('input-start-time-full').value;
        const totalTime = ""; // å‚³éç©ºå­—ä¸²ï¼Œå¼·åˆ¶å¾Œç«¯è‡ªå‹•è¨ˆç®—
        const formNo = document.getElementById('input-form-no').value;
        const reason = document.getElementById('input-reason').value;
        const concernSection = document.getElementById('input-concern-section').value;
        const solution = document.getElementById('input-solution').value;
        const selfActions = document.getElementById('input-self-actions').value;
        
        if (formNo.trim() === "") {
            alert("è«‹å¡«å¯« Repair Form No ä»¥ä¾¿è¿½è¹¤ã€‚");
            return;
        }

        const hasData = processedImageBase64 || machine || reason || solution || concernSection || selfActions || stopTimeFull || startTimeFull;

        if (!hasData) {
            alert("Empty! Please fill in machine info/notes or take a photo."); return;
        }
        
        saveEmployeeID();

        const scriptUrl = `https://script.google.com/macros/s/${FIXED_SCRIPT_ID}/exec`;
        
        // ç¦ç”¨æŒ‰éˆ•
        document.querySelectorAll('.btn-main').forEach(btn => btn.disabled = true);

        showStatus('loading', 'Uploading...', 'è³‡æ–™ä¸Šå‚³ä¸­...');

        const data = {
            mode: currentMode, 
            image: processedImageBase64,
            employeeId: employeeId,
            machine: machine,
            stopTimeFull: stopTimeFull,
            startTimeFull: startTimeFull,
            totalTime: totalTime, 
            formNo: formNo,
            reason: reason,
            concernSection: concernSection,
            solution: solution,
            selfActions: selfActions,
            folderId: FIXED_FOLDER_ID
        };

        fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            const action = res.action || 'æ–°å¢';
            if (res.result === 'success') {
                showStatus('success', 'Upload Success!', `è³‡æ–™å·²æˆåŠŸ ${action}ï¼`);
                
                // *** æ–°å¢ï¼šå„²å­˜æœ¬åœ°ç´€éŒ„ ***
                saveRecord(data, action); 

                if (res.action === 'æ–°å¢') { 
                    clearInputs();
                }
                setTimeout(() => { closeStatusModal(); }, 2000);
            } else {
                showStatus('error', 'Upload Failed', `ä¸Šå‚³å¤±æ•—ï¼š${res.error || 'æœªçŸ¥çš„éŒ¯èª¤ã€‚'}`);
            }
        })
        .catch(e => {
            console.error(e);
            showStatus('error', 'Upload Failed', 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ã€‚');
        })
        .finally(() => {
            document.querySelectorAll('.btn-main').forEach(btn => btn.disabled = false);
        });
    }

    // ================= åœ–ç‰‡/èªéŸ³å‡½æ•¸ (Canvas è™•ç†é‚è¼¯) =================
    
    function triggerFile(id) {
        if (window.location.protocol === 'http:' && !window.location.hostname.includes('localhost')) {
            alert("âŒ ç›¸æ©ŸåŠŸèƒ½éœ€è¦ HTTPS å”å®šã€‚è«‹ä½¿ç”¨ Apps Script ç¶²å€é–‹å•Ÿã€‚");
            return;
        }
        document.getElementById(id).click();
    }
    
    // ä¿®æ”¹ handleFileï¼šè®€å–å¾Œç›´æ¥äº¤çµ¦ processImageWithCanvas è™•ç†
    function handleFile(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() { processImageWithCanvas(img); }; // è¼‰å…¥åœ–ç‰‡å¾Œé€²è¡Œè™•ç†
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
    
    // æ¢å¾© processImageWithCanvas å‡½æ•¸ï¼šæ ¹æ“šè¨­å®šçš„æ¯”ä¾‹é€²è¡Œç¸®æ”¾å’Œè£å‰ª
    function processImageWithCanvas(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const ratioStr = localStorage.getItem("cfg_ratio") || "4/3";
        
        let targetRatio = 4/3;
        let isFull = ratioStr === "FULL";

        if(ratioStr === "16/9") targetRatio = 16/9;
        else if(ratioStr === "9/16") targetRatio = 9/16;
        else if(ratioStr === "1/1") targetRatio = 1;

        let srcW = img.width; let srcH = img.height;
        let drawW, drawH, startX, startY;

        if (isFull) {
            drawW = srcW; drawH = srcH; startX = 0; startY = 0;
        } else {
            let srcRatio = srcW / srcH;
            
            // åˆ¤æ–·æ˜¯å¦éœ€è¦è£å‰ª (ä»¥å¡«å……å®¹å™¨ç‚ºæº–å‰‡)
            if (srcRatio > targetRatio) { // åŸå§‹åœ–ç‰‡å¤ªå¯¬ï¼Œè£å·¦å³ (ä¿ç•™ä¸­é–“)
                drawH = srcH; drawW = srcH * targetRatio;
                startX = (srcW - drawW) / 2; startY = 0;
            } else { // åŸå§‹åœ–ç‰‡å¤ªé«˜ï¼Œè£ä¸Šä¸‹ (ä¿ç•™ä¸­é–“)
                drawW = srcW; drawH = srcW / targetRatio;
                startX = 0; startY = (srcH - drawH) / 2;
            }
        }

        // ç¸®æ”¾åˆ°æœ€å¤§å¯¬åº¦
        const scale = MAX_IMAGE_WIDTH / drawW;
        canvas.width = MAX_IMAGE_WIDTH;
        canvas.height = drawH * scale;

        // ç¹ªè£½å’Œè£å‰ª
        ctx.drawImage(img, startX, startY, drawW, drawH, 0, 0, canvas.width, canvas.height);
        processedImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
        
        const preview = document.getElementById('preview-img');
        preview.src = processedImageBase64;
        preview.style.display = 'block';
        document.querySelector('.placeholder').style.display = 'none';

        if(isFull) {
             const container = document.getElementById('preview-container');
             container.classList.remove("ratio-4-3", "ratio-16-9", "ratio-9-16", "ratio-1-1");
             // FULL æ¨¡å¼ä¸‹ï¼Œè®“é è¦½å®¹å™¨è‡ªå‹•é©æ‡‰åœ–ç‰‡çš„å¯¦éš›å°ºå¯¸
             container.style.aspectRatio = `${canvas.width} / ${canvas.height}`; 
        } else {
             // ç¢ºä¿é FULL æ¨¡å¼ä¸‹æ‡‰ç”¨ CSS æ¯”ä¾‹
             applySettings();
        }
    }


    function toggleVoice(btn) {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert("âŒ èªéŸ³è¼¸å…¥è¢«é˜»æ“‹ï¼ç€è¦½å™¨ä¸æ”¯æ´ï¼Œæˆ–è«‹ç¢ºä¿ App é€é HTTPS ç¶²å€é–‹å•Ÿã€‚");
            return;
        }
        
        const targetId = btn.getAttribute('data-target');
        const targetArea = document.getElementById(targetId);

        if (isRecording && activeTextAreaId === targetId) {
            manualStopVoice();
        } else if (isRecording && activeTextAreaId !== targetId) {
             if(confirm(`ç›®å‰æ­£åœ¨éŒ„è£½å…¶ä»–æ¬„ä½ï¼Œç¢ºå®šè¦åˆ‡æ›åˆ° [${targetArea.previousElementSibling.innerText.trim()}] å—ï¼Ÿ`)) {
                 manualStopVoice();
                 // ç¨å¾®å»¶é²ä»¥ç¢ºä¿åœæ­¢å®Œæˆ
                 setTimeout(() => startVoice(btn, targetArea, targetId), 100);
             }
        } else {
            startVoice(btn, targetArea, targetId);
        }
    }
    
    function startVoice(btn, targetArea, targetId) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.lang = document.getElementById('voice-lang-select').value || 'cmn-Hant-TW';
        recognition.continuous = true;
        recognition.interimResults = true;

        isRecording = true;
        activeTextAreaId = targetId;
        
        document.querySelectorAll('.btn-voice').forEach(b => b.classList.remove('recording'));
        btn.classList.add('recording');
        btn.innerText = "ğŸ›‘ åœæ­¢éŒ„éŸ³";
        
        snapshotText = targetArea.value;
        if(snapshotText.length > 0 && !snapshotText.endsWith(" ")) {
            snapshotText += " ";
        }

        recognition.onresult = function(event) {
            let currentSessionText = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                currentSessionText += event.results[i][0].transcript;
            }

            targetArea.value = snapshotText + currentSessionText;
            targetArea.scrollTop = targetArea.scrollHeight;

            if(punctuationTimer) clearTimeout(punctuationTimer);
            
            if(currentSessionText.trim().length > 0) {
                const timeoutMs = parseFloat(localStorage.getItem("cfg_timeout") || DEFAULT_VOICE_TIMEOUT) * 1000;
                punctuationTimer = setTimeout(() => {
                    manualStopVoice();
                }, timeoutMs);
            }
        };

        recognition.onend = function() {
            if(punctuationTimer) clearTimeout(punctuationTimer);
            resetVoiceUI();
        };
        
        recognition.onerror = function(event) {
            console.error("Speech Recognition Error:", event.error);
            resetVoiceUI();
            alert(`âŒ èªéŸ³è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤ï¼è«‹æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™æˆ– App æ˜¯å¦åœ¨ HTTPS ç’°å¢ƒä¸­ã€‚éŒ¯èª¤ç¢¼: ${event.error}`);
        };
        
        try {
            recognition.start();
        } catch(e) {
            console.error("Start error", e);
            resetVoiceUI();
            alert("âŒ èªéŸ³ API å•Ÿå‹•å¤±æ•—ã€‚è«‹ç¢ºèªç€è¦½å™¨æ”¯æ´å’Œæ¬Šé™ã€‚");
        }
    }

    function manualStopVoice() {
        if(isRecording && recognition) {
            isRecording = false;
            if(punctuationTimer) clearTimeout(punctuationTimer);

            // æ–°å¢æ¨™é»ç¬¦è™Ÿé‚è¼¯
            const targetArea = document.getElementById(activeTextAreaId);
            let currentVal = targetArea.value.trim();
            if(currentVal.length > 0) {
                const lastChar = currentVal.slice(-1);
                const lang = document.getElementById('voice-lang-select').value;
                const marks = lang.includes('en') ? [",", ".", "?", "!"] : ["ï¼Œ", "ã€‚", "ã€", "ï¼Ÿ", "ï¼"];
                
                if(!marks.includes(lastChar)) {
                    const mark = lang.includes('en') ? ". " : "ã€‚";
                    currentVal += mark;
                    targetArea.value = currentVal;
                }
            }
            
            recognition.stop();
        }
    }

    function resetVoiceUI() {
        if(punctuationTimer) clearTimeout(punctuationTimer);
        
        document.querySelectorAll('.btn-voice').forEach(b => {
             b.classList.remove('recording');
             b.innerText = "ğŸ¤ èªéŸ³è¼¸å…¥";
        });
        
        isRecording = false;
        activeTextAreaId = null;
    }

    function showStatus(type, title, subtitle) {
        const modal = document.getElementById('status-modal');
        const spinner = document.getElementById('status-spinner');
        const icon = document.getElementById('status-icon');
        const text = document.getElementById('status-text');
        const sub = document.getElementById('status-subtext');
        const closeBtn = document.getElementById('status-close-btn');

        modal.style.display = 'flex';
        text.innerText = title; sub.innerText = subtitle;

        spinner.style.display = (type === 'loading') ? 'block' : 'none';
        icon.style.display = (type !== 'loading') ? 'block' : 'none';
        closeBtn.style.display = (type === 'error') ? 'block' : 'none';

        if(type === 'success') icon.innerText = 'âœ…';
        else if(type === 'error') icon.innerText = 'âŒ';
    }

    function closeStatusModal() { document.getElementById('status-modal').style.display = 'none'; }

    function viewExcel() {
        const url = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/edit#gid=0`;
        window.open(url, '_blank');
    }

    function viewDriveFolder() {
        if(FIXED_FOLDER_ID && FIXED_FOLDER_ID.trim() !== "") {
            window.open(`https://drive.google.com/drive/folders/${FIXED_FOLDER_ID}`, '_blank');
        } else {
            alert("Folder ID not set.");
        }
    }
</script>

</body>
</html>
