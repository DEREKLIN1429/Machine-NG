<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine-NG (é‡é»äº‹é …ç´€éŒ„)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --danger-color: #dc3545;
            --drive-color: #198754; 
            --frame-color: #00e600; 
            --input-border: #ccc;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0;
            display: flex; justify-content: center; height: 100vh;
        }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 80%; max-width: 300px;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #ddd;
            border-radius: 8px; font-size: 18px; text-align: center;
        }

        #status-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
        }
        .status-box {
            background: white; padding: 25px; border-radius: 12px; width: 80%; max-width: 280px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .status-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-close-btn {
            background: var(--primary-color); color: white; border: none; padding: 8px 20px;
            border-radius: 5px; margin-top: 15px; cursor: pointer; display: none; font-size: 16px;
        }

        #app-screen { display: none; width: 100%; max-width: 500px; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        
        .author-header {
            text-align: center; font-size: 0.75rem; color: #999; padding-bottom: 10px;
            letter-spacing: 1px; font-weight: 500;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .header-btn { 
            font-size: 26px; cursor: pointer; color: #555; padding: 8px; 
            border-radius: 50%; transition: background 0.2s, color 0.2s;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        }
        .header-btn:active { background: #e9ecef; }
        
        .header-title { text-align: center; flex-grow: 1; }
        .header-title h2 { margin: 0; color: #333; font-size: 1.3rem; line-height: 1.4; }
        .header-title span { font-size: 0.85em; color: #666; font-weight: normal; }

        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 10px; display: block; font-size: 1rem; }

        .photo-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-half { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-cam { background-color: #ffc107; color: #333; }
        .btn-gallery { background-color: #fd7e14; }

        /* ... ç…§ç‰‡é è¦½æ¡†æ¨£å¼ (çœç•¥æœªæ”¹å‹•çš„ CSS) ... */
        #preview-container { 
            width: 100%; background: #f0fff0; border: 2px solid var(--frame-color);
            border-radius: 8px; display: flex; align-items: center; justify-content: center; 
            overflow: hidden; position: relative; box-sizing: border-box;
            transition: aspect-ratio 0.3s ease; box-shadow: 0 0 10px rgba(0, 230, 0, 0.15);
            cursor: pointer;
        }

        /* --- è¼¸å…¥æ¬„ä½æ¨£å¼ --- */
        .input-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .input-label { font-weight: bold; font-size: 0.95rem; color: #333; margin-bottom: 4px; }
        .text-input, textarea { 
            width: 100%; padding: 10px; border: 1px solid var(--input-border); 
            border-radius: 6px; font-size: 15px; box-sizing: border-box;
            font-family: inherit; transition: border-color 0.3s;
        }
        textarea { height: 120px; resize: vertical; } 
        
        .date-time-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .date-time-group > div { flex: 1 1 45%; min-width: 100px; }

        /* --- èªéŸ³å°ˆç”¨ CSS (é‡æ–°å•Ÿç”¨) --- */
        .voice-control-group {
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-voice { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 5px; 
            background-color: #17a2b8; 
            color: white; 
            font-weight: bold; 
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-voice:active { background-color: #0b7e92; }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .recording { background-color: var(--danger-color) !important; animation: pulse 1s infinite; }

        .footer-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; padding-bottom: 30px;}
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; }
        .btn-save { background-color: var(--primary-color); }
        .btn-view { background-color: #6c757d; }
        .btn-drive { background-color: var(--drive-color); }
        
        /* ... å…¶ä»–æœªæ”¹å‹•çš„ CSS ... */
        .hidden { display: none !important; }
    </style>
</head>
<body onload="initApp()">

    <div id="login-screen">
        <div class="login-box">
            <h3>ğŸ”’ Login (ç™»å…¥)</h3>
            <p style="color:#666; font-size:0.9em;">Please enter password<br>(è«‹è¼¸å…¥å¯†ç¢¼)</p>
            <input type="password" id="loginPass" class="login-input" placeholder="Password">
            <button class="btn-main btn-save" onclick="checkLogin()">Login (é€²å…¥)</button>
        </div>
    </div>

    <div id="status-modal">
        <div class="status-box">
            <div id="status-spinner" class="spinner"></div>
            <div id="status-icon" class="status-icon" style="display:none;"></div>
            <h3 id="status-text" style="color:#333; margin:0;">Uploading...</h3>
            <p id="status-subtext" style="color:#666; font-size:0.9em; margin-top:5px;">(è³‡æ–™ä¸Šå‚³ä¸­...)</p>
            <button id="status-close-btn" onclick="closeStatusModal()">OK</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="author-header">Author: DERER LIN</div>

        <div class="header">
            <div class="header-btn" onclick="logout()" title="Lock / Logout (é–å®š/ç™»å‡º)">ğŸ”’</div>
            <div class="header-title">
                <h2>Machine-NG<br>é‡é»äº‹é …ç´€éŒ„</h2>
            </div>
            <div class="header-btn" onclick="openSettings()" title="Settings (è¨­å®š)">âš™ï¸</div>
        </div>

        <div class="card">
            <span class="section-title">1. Photo (åœ–ç‰‡ç´€éŒ„)</span>
            <div class="photo-controls">
                <button class="btn-half btn-cam" onclick="triggerCam()">ğŸ“· Camera (æ‹ç…§)</button>
                <button class="btn-half btn-gallery" onclick="triggerGallery()">ğŸ–¼ï¸ Gallery (ç›¸ç°¿)</button>
            </div>
            
            <div id="preview-container" class="ratio-4-3" onclick="triggerCam()" title="Click to take photo">
                <div class="ratio-tag" id="ratio-display-tag">Ratio: 4:3</div>
                <span class="placeholder">Tap here to Take Photo<br>(é»æ“Šæ­¤è™•æ‹ç…§)</span>
                <img id="preview-img">
            </div>
            
            <input type="file" id="input-cam" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">
            <input type="file" id="input-gallery" accept="image/*" class="hidden" onchange="handleFile(this)">
        </div>

        <div class="card" id="info-card">
            <span class="section-title" id="machine-info-title">2. Machine NG Information</span>
            
            <div class="input-group">
                <label class="input-label" for="input-machine">Machine :</label>
                <input type="text" id="input-machine" class="text-input" placeholder="e.g. A01">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-form-no">Repair Form No:</label>
                <input type="text" id="input-form-no" class="text-input" placeholder="e.g. RF20251202">
            </div>

            <div class="date-time-group">
                <div>
                    <label class="input-label" for="input-stop-time-full">Stop time : (DD/MM/YYYY hh:mm)</label>
                    <input type="text" id="input-stop-time-full" class="text-input" placeholder="e.g. 02/12/2025 15:30">
                </div>
                <div>
                    <label class="input-label" for="input-start-time-full">Start time : (DD/MM/YYYY hh:mm)</label>
                    <input type="text" id="input-start-time-full" class="text-input" placeholder="e.g. 02/12/2025 18:00">
                </div>
            </div>
            
            <div class="input-group">
                <button type="button" class="btn-main btn-view" onclick="updateTimeNow()" 
                        style="background-color: #ffc107; color: #333; padding: 10px; margin-top: 5px;">
                    ğŸ”„ æ›´æ–°ç‚ºç¾åœ¨æ™‚é–“ (è‡ªå‹•å¡«å…¥ Stop/Start time)
                </button>
            </div>

            <div class="input-group">
                <label class="input-label" for="input-total-time">Total stop time :</label>
                <input type="text" id="input-total-time" class="text-input" placeholder="e.g. 2.5h (æ‰‹å‹•è¨ˆç®—)">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-reason">Reason :</label>
                <textarea id="input-reason" placeholder="Describe the reason for the failure... (è«‹æè¿°æ•…éšœåŸå› ...)"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-reason" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                    <span style="font-size: 0.8em; color: #666;"> (é»æ“Šå¾Œé–‹å§‹éŒ„éŸ³ï¼Œéœé»˜ 1.5 ç§’è‡ªå‹•åœæ­¢)</span>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-solution">How to Solve Problem:</label>
                <textarea id="input-solution" placeholder="Describe the solution taken... (è«‹æè¿°æ¡å–çš„è§£æ±ºæ–¹æ¡ˆ...)"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-solution" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                </div>
            </div>
            
            <select id="voice-lang-select" class="hidden">
                <option value="cmn-Hant-TW">ä¸­æ–‡ (ç¹é«”)</option>
                <option value="en-US">English</option>
                <option value="ja-JP">æ—¥æœ¬èª</option>
                <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)</option>
            </select>
        </div>

        <div class="footer-btns">
            <button class="btn-main btn-save" id="saveBtn" onclick="saveToCloud()">ğŸ’¾ Save to Cloud (å­˜æª”è‡³é›²ç«¯)</button>
            <button class="btn-main btn-view" onclick="viewExcel()">ğŸ“Š View Excel (æª¢è¦– Excel)</button>
            <button class="btn-main btn-drive" onclick="viewDriveFolder()">ğŸ“‚ View Photos (æª¢è¦–é›²ç«¯ç…§ç‰‡)</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings (è¨­å®š)</h3>
                <button onclick="closeSettings()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="modal-group" style="background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
                <label style="color:#d63384;">ğŸ”‘ Login Password (ä¿®æ”¹ç™»å…¥å¯†ç¢¼)</label>
                <input type="text" id="set-password" class="modal-input" placeholder="Current: 1234">
            </div>

            <div class="modal-group">
                <label>1. Photo Aspect Ratio (ç…§ç‰‡æ¯”ä¾‹)</label>
                <select id="set-ratio" class="modal-input">
                    <option value="4/3">4:3 (Standard)</option>
                    <option value="16/9">16:9 (Wide)</option>
                    <option value="9/16">9:16 (Vertical / ç›´å¼)</option>
                    <option value="1/1">1:1 (Square)</option>
                    <option value="FULL">FULL (Original / å…¨ç•«é¢)</option>
                </select>
                <div class="hint-text">* Applies auto-crop unless set to FULL.</div>
            </div>
            
            <div class="modal-group">
                <label>2. Voice Language (èªéŸ³è¾¨è­˜èªè¨€)</label>
                <select id="set-lang" class="modal-input" onchange="syncLanguage()">
                    <option value="cmn-Hant-TW">Traditional Chinese (ç¹é«”ä¸­æ–‡)</option>
                    <option value="en-US">English (è‹±æ–‡)</option>
                    <option value="ja-JP">Japanese (æ—¥æ–‡)</option>
                    <option value="hi-IN">Hindi (å°åœ°èª)</option>
                </select>
            </div>


            <div style="text-align: center; color: var(--primary-color); font-size: 0.9em; margin-top: 15px;">
                <p>âœ… Cloud Paths are Locked (System Mode)</p>
            </div>

            <button class="btn-main btn-save" onclick="saveSettings()">Save Settings (å„²å­˜è¨­å®š)</button>
        </div>
    </div>

<script>
    // ================= åˆå§‹åŒ–èˆ‡é›²ç«¯è¨­å®š (ä¿æŒä¸è®Š) =================
    const DEFAULT_PASS = "1234"; 
    
    // --- é€™è£¡æ˜¯ä½ è¦æ±‚çš„å¯«æ­»è·¯å¾‘ (FIXED PATHS) ---
    const FIXED_SCRIPT_ID = "AKfycbzfPzPODQjp_phrHPwjsoBYeA8-VgeaoYly6hr3Mx09Wj-o5tWHMPa-nTHfaHyloiH8zg/exec";
    const FIXED_SHEET_ID = "1sDKZBJfasUbZSGNAfz9GIWfRdrdXxQMrXrxM3x9RlCY/edit?gid=0#gid=0";
    const FIXED_FOLDER_ID = "1-DEvjARQ0tMdszpH7dLOBLm32KNjbDGu";

    let processedImageBase64 = ""; 
    
    // --- èªéŸ³ç›¸é—œè®Šæ•¸ ---
    let recognition;
    let isRecording = false; 
    let activeTextAreaId = null; 
    let snapshotText = "";       
    let punctuationTimer = null; 

    // ================= æ™‚é–“è™•ç†å‡½æ•¸ (æ–°å¢) =================
    // è¼”åŠ©å‡½æ•¸ï¼šå–å¾— DD/MM/YYYY hh:mm æ ¼å¼å­—ä¸²
    function getFullDateTimeString(dateObj) {
        const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
        
        const datePart = dateObj.toLocaleDateString('en-US', dateOptions).replace(/\//g, '/'); // æ ¼å¼ DD/MM/YYYY
        // æ ¼å¼ hh:mm (ç¢ºä¿å°æ™‚æ˜¯å…©ä½æ•¸)
        const timePart = dateObj.toLocaleTimeString('en-US', timeOptions).replace(/^(\d):/,'0$1:'); 
        
        return `${datePart} ${timePart}`;
    }

    // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚è¨­å®šåˆå§‹æ™‚é–“ (DD/MM/YYYY hh:mm)
    function setInitialDateTime() {
        const fullDateTime = getFullDateTimeString(new Date());

        // è‡ªå‹•å¸¶å…¥ Stop time å’Œ Start time
        document.getElementById('input-stop-time-full').value = fullDateTime;
        document.getElementById('input-start-time-full').value = fullDateTime;
    }
    
    // æŒ‰éˆ•é»æ“Šæ™‚æ›´æ–°æ™‚é–“
    function updateTimeNow() {
        if (!confirm("ç¢ºå®šå°‡ Stop time å’Œ Start time éƒ½æ›´æ–°ç‚ºç¾åœ¨æ™‚é–“å—ï¼Ÿ")) return;
        setInitialDateTime(); // é‡è¤‡ä½¿ç”¨åˆå§‹è¨­å®šå‡½æ•¸
    }


    // ================= æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯ (èª¿æ•´ initApp) =================

    function initApp() {
        if(!localStorage.getItem("app_password")) {
            localStorage.setItem("app_password", DEFAULT_PASS);
        }
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        if(isLoggedIn === "true") {
            showApp();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
        loadSettingsToUI();
        setInitialDateTime(); // å•Ÿå‹•æ™‚è‡ªå‹•å¸¶å…¥æ—¥æœŸæ™‚é–“
    }
    
    // ... (ç™»å…¥ã€ç™»å‡ºã€åœ–ç‰‡è™•ç†ã€Settings å‡½æ•¸ä¿æŒä¸è®Š) ...
    function checkLogin() {
        const input = document.getElementById('loginPass').value;
        const storedPass = localStorage.getItem("app_password");
        if(input === storedPass) {
            localStorage.setItem("isLoggedIn", "true");
            showApp();
        } else {
            alert("Wrong Password! (å¯†ç¢¼éŒ¯èª¤)");
        }
    }
    // ... (å…¶ä»–è¨­å®šã€åœ–ç‰‡è™•ç†é‚è¼¯ä¿æŒä¸è®Š) ...


    // ================= èªéŸ³åŠŸèƒ½ (ä¿æŒä¸è®Š) =================
    function toggleVoice(btn) {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert("Browser not supported / ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ã€‚"); return;
        }
        
        const targetId = btn.getAttribute('data-target');
        const targetArea = document.getElementById(targetId);

        if (isRecording && activeTextAreaId === targetId) {
            manualStopVoice(); 
        } else if (isRecording && activeTextAreaId !== targetId) {
             if(confirm(`ç›®å‰æ­£åœ¨éŒ„è£½ ${document.getElementById(activeTextAreaId).previousElementSibling.innerText.trim()}ï¼Œç¢ºå®šè¦åˆ‡æ›åˆ°æ–°æ¬„ä½å—ï¼Ÿ`)) {
                manualStopVoice();
                startVoice(btn, targetArea, targetId);
             }
        } else {
            startVoice(btn, targetArea, targetId);
        }
    }
    
    function startVoice(btn, targetArea, targetId) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.lang = document.getElementById('voice-lang-select').value || 'cmn-Hant-TW';
        recognition.continuous = true; 
        recognition.interimResults = true; 

        isRecording = true;
        activeTextAreaId = targetId;
        
        document.querySelectorAll('.btn-voice').forEach(b => b.classList.remove('recording'));
        btn.classList.add('recording');
        btn.innerText = "ğŸ›‘ åœæ­¢éŒ„éŸ³";
        
        snapshotText = targetArea.value;
        if(snapshotText.length > 0 && !snapshotText.endsWith(" ")) {
            snapshotText += " ";
        }

        recognition.onresult = function(event) {
            let currentSessionText = ''; 
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                currentSessionText += event.results[i][0].transcript;
            }

            targetArea.value = snapshotText + currentSessionText;
            targetArea.scrollTop = targetArea.scrollHeight;

            if(punctuationTimer) clearTimeout(punctuationTimer);
            
            if(currentSessionText.trim().length > 0) {
                punctuationTimer = setTimeout(() => {
                    manualStopVoice(); 
                }, 1500); 
            }
        };

        recognition.onend = function() {
            if(punctuationTimer) clearTimeout(punctuationTimer);
            resetVoiceUI();
        };
        
        recognition.onerror = function(event) {
            console.error("Speech Recognition Error:", event.error);
            resetVoiceUI();
            alert(`èªéŸ³è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤: ${event.error}`);
        };
        
        try {
            recognition.start();
        } catch(e) {
            console.error("Start error", e);
            resetVoiceUI();
        }
    }

    function manualStopVoice() {
        if(isRecording && recognition) {
            isRecording = false; 
            if(punctuationTimer) clearTimeout(punctuationTimer);

            const targetArea = document.getElementById(activeTextAreaId);
            let currentVal = targetArea.value.trim();
            if(currentVal.length > 0) {
                const lastChar = currentVal.slice(-1);
                const lang = document.getElementById('voice-lang-select').value;
                const marks = lang.includes('en') ? [",", "."] : ["ï¼Œ", "ã€‚", "ã€", "ï¼Ÿ", "ï¼"];
                
                if(!marks.includes(lastChar)) {
                    const mark = lang.includes('en') ? ". " : "ã€‚";
                    currentVal += mark;
                    targetArea.value = currentVal;
                }
            }

            recognition.stop();
            resetVoiceUI();
        }
    }

    function resetVoiceUI() {
        if(punctuationTimer) clearTimeout(punctuationTimer);
        
        document.querySelectorAll('.btn-voice').forEach(b => {
             b.classList.remove('recording');
             b.innerText = "ğŸ¤ èªéŸ³è¼¸å…¥";
        });
        
        isRecording = false;
        activeTextAreaId = null;
    }


    // ================= ä¸Šå‚³èˆ‡æª¢è¦– (ä¿æŒä¸è®Š) =================
    function showStatus(type, title, subtitle) {
        const modal = document.getElementById('status-modal');
        const spinner = document.getElementById('status-spinner');
        const icon = document.getElementById('status-icon');
        const text = document.getElementById('status-text');
        const sub = document.getElementById('status-subtext');
        const closeBtn = document.getElementById('status-close-btn');

        modal.style.display = 'flex';
        text.innerText = title; sub.innerText = subtitle;

        if(type === 'loading') {
            spinner.style.display = 'block'; icon.style.display = 'none'; closeBtn.style.display = 'none';
        } else if(type === 'success') {
            spinner.style.display = 'none'; icon.style.display = 'block'; icon.innerText = 'âœ…'; closeBtn.style.display = 'none';
        } else if(type === 'error') {
            spinner.style.display = 'none'; icon.style.display = 'block'; icon.innerText = 'âŒ'; closeBtn.style.display = 'block';
        }
    }

    function closeStatusModal() { document.getElementById('status-modal').style.display = 'none'; }

    function saveToCloud() {
        // å…ˆåœæ­¢æ‰€æœ‰èªéŸ³éŒ„è£½
        if(isRecording) {
            manualStopVoice();
        }

        // 1. è’é›†æ‰€æœ‰æ¬„ä½è³‡æ–™
        const machine = document.getElementById('input-machine').value;
        const stopTimeFull = document.getElementById('input-stop-time-full').value; 
        const startTimeFull = document.getElementById('input-start-time-full').value; 
        const totalTime = document.getElementById('input-total-time').value;
        const formNo = document.getElementById('input-form-no').value;
        const reason = document.getElementById('input-reason').value;
        const solution = document.getElementById('input-solution').value; 

        // 2. æª¢æŸ¥åŸºæœ¬è³‡æ–™å®Œæ•´æ€§
        if(!processedImageBase64 && !machine && !reason && !solution) {
            alert("Empty! Please fill in machine info/notes or take a photo."); return;
        }

        const folderId = FIXED_FOLDER_ID;
        const scriptUrl = `https://script.google.com/macros/s/${FIXED_SCRIPT_ID}/exec`;

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        showStatus('loading', 'Uploading...', 'è³‡æ–™ä¸Šå‚³ä¸­...');

        // 3. æº–å‚™å‚³è¼¸çš„è³‡æ–™ç‰©ä»¶ (Key ä¿æŒä¸è®Šï¼Œå°æ‡‰ Apps Script)
        const data = { 
            image: processedImageBase64, 
            machine: machine,
            stopTimeFull: stopTimeFull,
            startTimeFull: startTimeFull,
            totalTime: totalTime,
            formNo: formNo,
            reason: reason, 
            solution: solution, 
            folderId: folderId
        };

        fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            showStatus('success', 'Upload Success!', 'ä¸Šå‚³æˆåŠŸï¼');
            // æ¸…é™¤æ¬„ä½
            document.getElementById('input-machine').value = "";
            document.getElementById('input-total-time').value = "";
            document.getElementById('input-form-no').value = "";
            document.getElementById('input-reason').value = "";
            document.getElementById('input-solution').value = "";

            // é‡è¨­æ—¥æœŸæ™‚é–“
            setInitialDateTime();

            // æ¸…é™¤åœ–ç‰‡
            processedImageBase64 = "";
            document.getElementById('preview-img').style.display = 'none';
            document.querySelector('.placeholder').style.display = 'block';
            applySettings();
            setTimeout(() => { closeStatusModal(); }, 2000);
        })
        .catch(e => {
            console.error(e);
            showStatus('error', 'Upload Failed', 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
        })
        .finally(() => {
            btn.disabled = false;
        });
    }

    function viewExcel() {
        const url = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/edit`;
        window.open(url, '_blank');
    }

    function viewDriveFolder() {
        const folderId = FIXED_FOLDER_ID;
        if(folderId && folderId.trim() !== "") {
            window.open("https://drive.google.com/drive/folders/" + folderId, '_blank');
        } else {
            if(confirm("Folder ID not set. Open Google Drive Root?\n(å°šæœªè¨­å®šè³‡æ–™å¤¾ IDï¼Œè¦é–‹å•Ÿé›²ç«¯ç¡¬ç¢Ÿæ ¹ç›®éŒ„å—ï¼Ÿ)")) {
                window.open("https://drive.google.com/drive/my-drive", '_blank');
            }
        }
    }
</script>

</body>
</html>
