/**
 * 核心函數：處理來自前端的 POST/GET 請求。
 * 支援操作: append (新增), overwrite (覆蓋), query (查詢)。
 * @param {object} e - 包含請求資料的事件物件。
 */
function doPost(e) {
  var result = {"result": "error", "error": "Unknown error."};
  
  try {
    var data = JSON.parse(e.postData.contents);
    var action = data.action || 'append'; // 預設為新增
    
    result = handleDataSubmission(data, action);
    
  } catch (error) {
    result.error = "Request processing error: " + error.message + " Stack: " + error.stack;
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  var result = {"result": "error", "error": "Unknown error."};
  
  try {
    var action = e.parameter.action;
    var formNo = e.parameter.formNo;

    if (action === 'query' && formNo) {
      result = queryData(formNo);
    } else {
      result.error = "Invalid GET parameters or missing action/formNo.";
    }
    
  } catch (error) {
    result.error = "GET processing error: " + error.message;
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * 處理資料新增或覆蓋的核心邏輯。
 */
function handleDataSubmission(data, action) {
  var result = {"result": "error"};
  
  // --- 接收所有欄位 ---
  var employeeId = data.employeeId || "";
  var machine = data.machine || "";
  var stopTimeFull = data.stopTimeFull || "";
  var startTimeFull = data.startTimeFull || "";
  var totalTime = data.totalTime || ""; 
  var formNo = data.formNo || "";
  var reason = data.reason || "";
  var concernSection = data.concernSection || ""; 
  var solution = data.solution || "";
  var selfActions = data.selfActions || ""; 
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  
  // --- 圖片處理部分 ---
  var now = new Date();
  var fileName = Utilities.formatDate(now, "GMT+8", "yyyyMMddHHmmss") + ".jpg";

  var imageCell = "No Image";
  var viewUrl = "";

  if (data.image && data.image !== "") {
    var folder = DriveApp.getRootFolder();
    if (data.folderId && data.folderId.trim() !== "") {
      try {
        folder = DriveApp.getFolderById(data.folderId.trim());
      } catch (err) {}
    }

    var contentType = data.image.substring(5, data.image.indexOf(';'));
    var base64Data = data.image.substr(data.image.indexOf('base64,') + 7);
    var bytes = Utilities.base64Decode(base64Data);
    var blob = Utilities.newBlob(bytes, contentType, fileName); 
    
    // 如果是覆蓋模式，並且存在舊檔案，則這裡需要刪除/替換舊檔案
    // 為了簡化，目前邏輯是：覆蓋模式下也上傳新檔案，如果需要刪除舊檔案，則需要更多前端資料來判斷舊檔案 ID。
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    viewUrl = file.getUrl();
    var fileId = file.getId();
    var directLink = "https://drive.google.com/uc?export=view&id=" + fileId;
    imageCell = '=HYPERLINK("' + viewUrl + '", IMAGE("' + directLink + '", 1))'; 
  }
  
  // --- 寫入資料陣列 (與前端對應的順序) ---
  var rowData = [
    now, employeeId, machine, formNo, stopTimeFull, startTimeFull, totalTime,
    imageCell, reason, concernSection, solution, selfActions, viewUrl, fileName
  ];

  if (action === 'append') {
    // 1. 新增模式
    sheet.appendRow(rowData);
    sheet.setRowHeight(sheet.getLastRow(), 100); 
    result.result = "success";
    result.rowIndex = sheet.getLastRow();
    
  } else if (action === 'overwrite' && data.rowIndex && data.rowIndex > 0) {
    // 2. 覆蓋模式
    var rowIndex = parseInt(data.rowIndex);
    var range = sheet.getRange(rowIndex, 1, 1, rowData.length);
    range.setValues([rowData]);
    sheet.setRowHeight(rowIndex, 100); 
    result.result = "success";
    result.rowIndex = rowIndex;
    
  } else {
    result.error = "Invalid action or missing rowIndex for overwrite.";
  }
  
  return result;
}


/**
 * 根據 Repair Form No 查詢單筆資料。
 */
function queryData(formNo) {
  var result = {"result": "error"};
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var dataRange = sheet.getDataRange();
  var values = dataRange.getValues();
  
  // 假設 Repair Form No 在第 4 欄 (Col D, 陣列索引 3)
  var formNoColumnIndex = 3; 

  // 從第 2 行開始尋找 (跳過標題)
  for (var i = 1; i < values.length; i++) {
    var row = values[i];
    if (row[formNoColumnIndex] && String(row[formNoColumnIndex]).trim().toUpperCase() === String(formNo).trim().toUpperCase()) {
      
      // 找到匹配項，返回資料和行號 (Apps Script 行號從 1 開始)
      result.result = "success";
      result.rowIndex = i + 1; 
      
      // 映射資料到前端所需的 Keys
      result.data = {
        // Apps Script Index: 0       1           2         3           4               5                 6           7              8               9                 10           11          12            13
        // Sheet Column:     A       B           C         D           E               F                 G           H              I               J                 K            L           M             N
        // Data Field:       Time    EmployeeID  Machine   FormNo      StopTimeFull    StartTimeFull     TotalTime   ImageCell      Reason          ConcernSection    Solution     SelfActions ViewUrl     FileName
        employeeId:     row[1],
        machine:        row[2],
        formNo:         row[3],
        stopTimeFull:   row[4],
        startTimeFull:  row[5],
        totalTime:      row[6],
        photoUrl:       row[12], // 從 ViewUrl (Col M) 獲取圖片連結
        reason:         row[8],
        concernSection: row[9],
        solution:       row[10],
        selfActions:    row[11]
      };
      
      return result;
    }
  }
  
  result.data = null; // 找不到資料
  result.error = "Repair Form No not found.";
  return result;
}
