<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine-NG (é‡é»äº‹é …ç´€éŒ„)</title>
    <style>
        :root {
            /* ä¸»é«”é…è‰²ï¼šé»‘ã€æ©˜ã€ç¶  */
            --primary-color: #4CAF50; /* ç¶ è‰² - ä¸»è¦/æˆåŠŸ/å„²å­˜ */
            --bg-color: #f7f9fc; 
            --card-bg: #ffffff;
            --danger-color: #e53935; 
            --copy-color: #FF9800; /* æ©˜è‰² - Copy/Drive */
            --view-color: #212121; /* é»‘è‰² - View/æ¬¡è¦ */
            --frame-color: #4CAF50; 
            --input-border: #ddd;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0;
            display: flex; justify-content: center; min-height: 100vh;
        }

        /* --- æ¨¡çµ„åŒ–æ¨£å¼ --- */
        #login-screen, #status-modal, #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        #login-screen { background: var(--bg-color); }

        .modal-box {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 450px;
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .login-input {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; 
            border-radius: 8px; font-size: 16px; text-align: left; 
            box-sizing: border-box;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #app-screen { width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-btn { 
            font-size: 24px; 
            cursor: pointer; color: #555; padding: 6px; 
            border-radius: 50%; transition: background 0.2s;
            width: 36px; height: 36px; 
            display: flex; align-items: center; justify-content: center;
        }
        .header-title h2 { margin: 0; color: #333; font-size: 1.2rem; line-height: 1.4; }

        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 8px; display: block; font-size: 1rem; }

        .photo-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-half { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-cam { background-color: #FF5722; color: white; } 
        .btn-gallery { background-color: #FFC107; color: #333; } 

        #preview-container {
            max-width: 100%; height: auto; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden;
            background: #e0e0e0; border-radius: 8px; min-height: 150px; 
        }
        .ratio-4-3 { aspect-ratio: 4 / 3; }
        .ratio-16-9 { aspect-ratio: 16 / 9; }
        .ratio-9-16 { aspect-ratio: 9 / 16; }
        .ratio-1-1 { aspect-ratio: 1 / 1; }
        #preview-container .placeholder { position: absolute; color: #666; font-size: 1.1em; font-weight: bold; text-align: center; }
        #preview-img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: cover; display: none; }
        #ratio-display-tag { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; z-index: 10; }

        .input-group { margin-bottom: 8px; display: flex; flex-direction: column; }
        .input-label { font-weight: bold; font-size: 0.9rem; color: #333; margin-bottom: 4px; }
        .text-input, textarea, select.text-input { 
            width: 100%; padding: 10px; border: 1px solid var(--input-border); 
            border-radius: 6px; font-size: 15px; box-sizing: border-box;
            font-family: inherit; transition: border-color 0.3s;
        }
        textarea { height: 80px; resize: vertical; } 
        
        .time-component { display: flex; flex-direction: column; margin-bottom: 8px; }
        .time-input-row { display: flex; align-items: center; gap: 5px; }
        .btn-update-time {
            padding: 10px 12px; border: none; background-color: #00bcd4; color: white;
            border-radius: 6px; cursor: pointer; font-weight: bold; line-height: 1; 
        }
        .total-time-input-group { display: flex; gap: 5px; align-items: center; }
        .total-time-input-group #input-total-time { flex-grow: 1; }
        .total-time-input-group #total-time-unit { width: 90px !important; }

        /* --- åº•éƒ¨æŒ‰éˆ•ç¾¤çµ„ --- */
        .footer-btns { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* å…©æ¬„ */
            gap: 10px; 
            margin-top: 15px; 
            padding-bottom: 20px;
        }
        .btn-main { 
            width: 100%; 
            /* ä¿®æ­£ï¼šä½¿ç”¨ 5/4 æ¯”ä¾‹ä¾†ç¸®æ¸›é«˜åº¦ 20% (æ¯”èµ· 1/1) */
            aspect-ratio: 5 / 4; 
            padding: 5px; 
            border: none; 
            border-radius: 8px; 
            font-size: 19px; /* å­—é«”ç¶­æŒåŠ å¤§ */
            font-weight: 700; 
            cursor: pointer; 
            color: white; 
            transition: background 0.2s, transform 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            text-align: center;
        }
        .btn-main:active { transform: scale(0.99); }
        .btn-save { background-color: var(--primary-color); }
        .btn-copy { background-color: var(--copy-color); }
        .btn-view { background-color: #03A9F4; }
        .btn-drive { background-color: #795548; }

        /* --- æœ€è¿‘ç´€éŒ„åˆ—è¡¨æ¨£å¼ --- */
        #recent-records-container {
            margin-top: 20px;
            padding: 15px; 
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #recent-records-container h4 {
            margin: 0 0 10px 0;
            color: var(--view-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        /* æ¸…é™¤æŒ‰éˆ•æ¨£å¼ */
        .btn-clear-history {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-clear-history:active { background: #ddd; }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            cursor: pointer;
            border-bottom: 1px dashed #f0f0f0;
            transition: background-color 0.2s;
        }
        .record-item:last-child { border-bottom: none; }
        .record-item:hover { background-color: #f9f9f9; }
        
        /* åˆ—è¡¨è³‡æ–™æ’ç‰ˆä¿®æ­£ */
        .record-item .main-info-group {
            display: flex;
            flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ—ï¼Œå› ç‚ºæ‰‹æ©Ÿå¯¬åº¦å¯èƒ½ä¸å¤  */
            gap: 2px;
            flex-shrink: 0;
            width: 45%; 
        }
        .record-item .form-no-display {
            font-weight: bold;
            color: var(--copy-color); 
            font-size: 1.1em;
        }
        .record-item .stop-time-display {
            font-weight: bold;
            color: #333; /* æ·±è‰²é¡¯ç¤ºæ™‚é–“ */
            font-size: 0.9em;
        }
        .record-item .details {
            font-size: 0.85rem;
            color: #777;
            text-align: right;
            line-height: 1.4;
            width: 55%;
        }

        .hidden { display: none !important; }
        .btn-voice.recording { background-color: var(--danger-color); color: white; }
    </style>
</head>
<body>

    <div id="login-screen" style="display: none;">
        <div class="modal-box">
            <h3>ğŸ”’ Login (ç™»å…¥)</h3>
            <p style="color:#666; font-size:0.9em;">Default Password: 12345<br>(è«‹è¼¸å…¥å¯†ç¢¼)</p>
            <input type="password" id="loginPass" class="login-input" placeholder="Password">
            <button class="btn-main btn-save" onclick="checkLogin()">Login (é€²å…¥)</button>
        </div>
    </div>

    <div id="status-modal" style="display: none;">
        <div class="modal-box">
            <div id="status-spinner" class="spinner"></div>
            <div id="status-icon" class="status-icon" style="display:none; font-size: 40px;"></div>
            <h3 id="status-text" style="color:#333; margin:0;">Uploading...</h3>
            <p id="status-subtext" style="color:#666; font-size:0.9em; margin-top:5px;">(è³‡æ–™ä¸Šå‚³ä¸­...)</p>
            <button id="status-close-btn" onclick="closeStatusModal()" class="btn-main btn-view" style="margin-top: 15px; display: none;">OK</button>
        </div>
    </div>
    
    <div id="settings-modal" style="display: none;">
        <div class="modal-box">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3>Settings (è¨­å®š)</h3>
                <button onclick="closeSettings()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="settings-content-group">
                <div class="modal-group" style="background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
                    <label style="color:#d63384; font-weight: bold; margin-bottom: 5px; display: block;">ğŸ”‘ Login Password (ä¿®æ”¹ç™»å…¥å¯†ç¢¼) (Default: 12345)</label>
                    <input type="text" id="set-password" class="login-input" style="margin: 0;" placeholder="Current: 12345">
                </div>

                <div class="modal-group">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">1. Voice Timeout (éŒ„éŸ³éœé»˜ç§’æ•¸)</label>
                    <input type="number" id="set-timeout" class="login-input" style="margin: 0;" placeholder="Default: 1.5 (seconds)">
                </div>

                <div class="modal-group">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">2. Photo Aspect Ratio (ç…§ç‰‡æ¯”ä¾‹)</label>
                    <select id="set-ratio" class="login-input" style="margin: 0;">
                        <option value="4/3">4:3 (Standard)</option>
                        <option value="16/9">16:9 (Wide)</option>
                        <option value="9/16">9:16 (Vertical / ç›´å¼)</option>
                        <option value="1/1">1:1 (Square)</option>
                    </select>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 3px;">* Applies auto-crop.</div>
                </div>
                
                <div class="modal-group">
                    <label style="font-weight: bold; margin-bottom: 5px; display: block;">3. Voice Language (èªéŸ³è¾¨è­˜èªè¨€)</label>
                    <select id="set-lang" class="login-input" style="margin: 0;" onchange="syncLanguage()">
                        <option value="cmn-Hant-TW">Traditional Chinese (ç¹é«”ä¸­æ–‡)</option>
                        <option value="en-US">English</option>
                        <option value="ja-JP">Japanese</option>
                        <option value="hi-IN">Hindi (å°åœ°èª)</option>
                    </select>
                </div>

                <div class="modal-group" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; color: var(--copy-color);">4. Concern Section List Management<br>(ç›¸é—œéƒ¨é–€åˆ—è¡¨ç®¡ç†)</label>
                    <input type="text" id="new-concern-section" class="login-input" style="margin: 0 0 5px 0;" placeholder="Add new section (e.g., Electrical)">
                    <button type="button" class="btn-add-item" onclick="addConcernSection()">+ Add Section (æ–°å¢)</button>
                    <div id="concern-section-list-container"></div>
                </div>
                
                <div class="modal-group" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block; color: var(--copy-color);">5. Machine List Management<br>(æ©Ÿå™¨åˆ—è¡¨ç®¡ç†)</label>
                    <input type="text" id="new-machine-name" class="login-input" style="margin: 0 0 5px 0;" placeholder="Add new machine name (e.g., CM4)">
                    <button type="button" class="btn-add-item" onclick="addMachine()">+ Add Machine (æ–°å¢)</button>
                    <div id="machine-list-container"></div>
                </div>
            </div>

            <div style="text-align: center; color: var(--primary-color); font-size: 0.9em; margin-top: 15px;">
                <p>âœ… Cloud Paths are Locked (System Mode)</p>
            </div>
            <button class="btn-main btn-save" onclick="saveSettings()">Save Settings (å„²å­˜è¨­å®š)</button>
        </div>
    </div>


    <div id="app-screen" style="display: none;">
        <div class="author-header">Author: DERER LIN (v3.7)</div>

        <div class="header">
            <div class="header-btn" onclick="logout()" title="Lock / Logout (é–å®š/ç™»å‡º)">ğŸ”’</div>
            <div class="header-title">
                <h2>Machine-NG<br>é‡é»äº‹é …ç´€éŒ„</h2>
            </div>
            <div class="header-btn" onclick="openSettings()" title="Settings (è¨­å®š)">âš™ï¸</div>
        </div>

        <div class="input-group">
            <label class="input-label" for="input-employee-id">Employee ID (å“¡å·¥ç·¨è™Ÿ):</label>
            <input type="text" id="input-employee-id" class="text-input" placeholder="å„²å­˜å¾Œä¸æœƒæ¸…é™¤">
        </div>

        <div class="card">
            <span class="section-title">1. Photo (åœ–ç‰‡ç´€éŒ„)</span>
            <div class="photo-controls">
                <button class="btn-half btn-cam" onclick="triggerFile('input-cam')">ğŸ“· Camera</button>
                <button class="btn-half btn-gallery" onclick="triggerFile('input-gallery')">ğŸ–¼ï¸ Gallery</button>
            </div>
            
            <div id="preview-container" class="ratio-4-3" onclick="triggerFile('input-cam')" title="Click to take photo">
                <div class="ratio-tag" id="ratio-display-tag">Ratio: 4:3</div>
                <span class="placeholder">Tap here to Take Photo</span>
                <img id="preview-img">
            </div>
            
            <input type="file" id="input-cam" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">
            <input type="file" id="input-gallery" accept="image/*" class="hidden" onchange="handleFile(this)">
        </div>

        <div class="card" id="info-card">
            <span class="section-title" id="machine-info-title">2. Machine NG Information</span>
            
            <div class="input-group">
                <label class="input-label" for="input-machine">Machine :</label>
                <select id="input-machine" class="text-input">
                    </select>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-form-no">Repair Form No:</label>
                <input type="text" id="input-form-no" class="text-input" placeholder="e.g. A69304">
            </div>

            <div class="time-component">
                <label class="input-label" for="input-stop-time-full">Stop time : (DD/MM/YYYY hh:mm)</label>
                <div class="time-input-row">
                    <input type="text" id="input-stop-time-full" class="text-input" 
                                placeholder="è«‹é»å³å´æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥" oninput="calculateTotalStopTime()">
                    <button type="button" class="btn-update-time" 
                                onclick="updateSingleTime('input-stop-time-full')" title="Set Current Time">
                        <span style="font-size: 1.1em;">â±ï¸</span>
                    </button>
                </div>
            </div>
            <div class="time-component">
                <label class="input-label" for="input-start-time-full">Start time : (DD/MM/YYYY hh:mm)</label>
                <div class="time-input-row">
                    <input type="text" id="input-start-time-full" class="text-input" 
                                placeholder="è«‹é»å³å´æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥" oninput="calculateTotalStopTime()">
                    <button type="button" class="btn-update-time" 
                                onclick="updateSingleTime('input-start-time-full')" title="Set Current Time">
                        <span style="font-size: 1.1em;">â±ï¸</span>
                    </button>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label" for="input-total-time">Total stop time : (è‡ªå‹•è¨ˆç®—)</label>
                <div class="total-time-input-group">
                    <input type="text" id="input-total-time" class="text-input" placeholder="" readonly style="background-color: #eee; font-weight: bold;">
                    <select id="total-time-unit" onchange="calculateTotalStopTime()" class="text-input" style="width: auto;">
                        <option value="h">hr (å°æ™‚)</option>
                        <option value="min">min (åˆ†é˜)</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-concern-section">Concern Section :</label>
                <select id="input-concern-section" class="text-input">
                    </select>
            </div>

            <div class="input-group">
                <label class="input-label" for="input-reason">Reason :</label>
                <textarea id="input-reason" placeholder="e.g. dischrge door not open"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-reason" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                    <span style="font-size: 0.8em; color: #666;"> (éœé»˜ 1.5 ç§’è‡ªå‹•åœæ­¢)</span>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label" for="input-solution">How to Solve Problem:</label>
                <textarea id="input-solution" placeholder="e.g. hydraulic pressure set"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-solution" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                </div>
            </div>
            
             <div class="input-group">
                <label class="input-label" for="input-self-actions">Self Actions:</label>
                <textarea id="input-self-actions" placeholder="e.g. check and inform maintenance team"></textarea>
                <div class="voice-control-group">
                    <button type="button" class="btn-voice" data-target="input-self-actions" onclick="toggleVoice(this)">
                        ğŸ¤ èªéŸ³è¼¸å…¥
                    </button>
                </div>
            </div>
            
            <select id="voice-lang-select" class="hidden">
                <option value="cmn-Hant-TW">ä¸­æ–‡ (ç¹é«”)</option>
                <option value="en-US">English</option>
                <option value="ja-JP">Japanese</option>
                <option value="hi-IN">Hindi (å°åœ°èª)</option>
            </select>
        </div>

        <div id="recent-records-container" class="card">
            <h4>
                æœ€è¿‘ç´€éŒ„ (Recent Records)
                <button class="btn-clear-history" onclick="clearRecentRecords()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </h4>
            <div id="recent-records-list">
                <p style="text-align: center; color: #999;">Loading recent records...</p>
            </div>
        </div>
        
        <div class="footer-btns">
            <button class="btn-main btn-copy" onclick="copyFormattedInfo()">ğŸ“‹<br>Copy Info</button>
            <button class="btn-main btn-save" id="saveBtn" onclick="saveToCloud()">ğŸ’¾<br>Save to Cloud</button>
            <button class="btn-main btn-view" onclick="viewExcel()">ğŸ“Š<br>View Excel</button>
            <button class="btn-main btn-drive" onclick="viewDriveFolder()">ğŸ“‚<br>View Photos</button>
        </div>
    </div>

<script>
    // ================= åƒæ•¸èˆ‡åˆå§‹åŒ– =================
    const DEFAULT_PASS = "12345"; 
    const MAX_IMAGE_WIDTH = 1000;
    const MACHINE_LIST_KEY = "cfg_machine_list";
    const CONCERN_LIST_KEY = "cfg_concern_list"; 
    const EMPLOYEE_ID_KEY = "cfg_employee_id"; 
    const DEFAULT_MACHINE_LIST = ["BM5", "BM6", "BM7", "BM21", "BM22", "BM23", "CA3", "CA4", "CM1", "CM2", "CM3"];
    const DEFAULT_CONCERN_LIST = ["Mixing", "Extrusion", "Cutting", "Calendering"]; 
    const DEFAULT_VOICE_TIMEOUT = 1.5;

    // TODO: è«‹å‹™å¿…ä¿®æ”¹ä»¥ä¸‹ä¸‰å€‹è·¯å¾‘
    const FIXED_SCRIPT_ID = "AKfycbzfPzPODQjp_phrHPwjsoBYeA8-VgeaoYly6hr3Mx09Wj-o5tWHMPa-nTHfaHyloiH8zg/exec"; 
    const FIXED_SHEET_ID = "1sDKZBJfasUbZSGNAfz9GIWfRdrdXxQMrXrxM3x9RlCY"; 
    const FIXED_FOLDER_ID = "1VPfLCMIuJPA66RjN8isrC4xq3luPMJe4"; 
    
    const GAS_URL = `https://script.google.com/macros/s/${FIXED_SCRIPT_ID}/exec`;

    // ç‹€æ…‹è®Šæ•¸
    let processedImageBase64 = ""; 
    let recognition = null;
    let isRecording = false; 
    let activeTextAreaId = null; 
    let snapshotText = ""; 
    let punctuationTimer = null; 

    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    function initApp() {
        if(!localStorage.getItem("app_password")) localStorage.setItem("app_password", DEFAULT_PASS);
        if(!localStorage.getItem(MACHINE_LIST_KEY)) localStorage.setItem(MACHINE_LIST_KEY, JSON.stringify(DEFAULT_MACHINE_LIST));
        if(!localStorage.getItem(CONCERN_LIST_KEY)) localStorage.setItem(CONCERN_LIST_KEY, JSON.stringify(DEFAULT_CONCERN_LIST));
        if(!localStorage.getItem("cfg_timeout")) localStorage.setItem("cfg_timeout", DEFAULT_VOICE_TIMEOUT);
        
        loadSettingsToUI();
        loadMachineListToUI();
        loadConcernSectionToUI(); 
        loadEmployeeID(); 
        
        document.getElementById('input-stop-time-full').value = "";
        document.getElementById('input-start-time-full').value = "";
        document.getElementById('input-total-time').value = "";
        document.getElementById('input-total-time').style.backgroundColor = '#eee';
        document.getElementById('total-time-unit').value = 'min'; 
        
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        if(isLoggedIn === "true") {
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('login-screen').style.display = 'none';
            applySettings();
            loadRecentRecords();
        } else {
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }
    }

    // ... (ç™»å…¥è¨­å®šå‡½å¼ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœé•·åº¦ï¼Œè«‹ä¿ç•™åŸæœ‰çš„å‡½æ•¸) ... 
    // åŒ…å«: checkLogin, logout, openSettings, closeSettings, saveSettings, loadSettingsToUI, applySettings, syncLanguage
    // åŒ…å«: getMachineList, saveMachineList, loadMachineListToUI, renderMachineListSettings, addMachine, removeMachine
    // åŒ…å«: getConcernList, saveConcernList, loadConcernSectionToUI, renderConcernListSettings, addConcernSection, removeConcernSection
    // åŒ…å«: loadEmployeeID, saveEmployeeID

    function checkLogin() {
        const inputPass = document.getElementById('loginPass').value;
        const storedPass = localStorage.getItem("app_password");
        if (inputPass === storedPass) {
            localStorage.setItem("isLoggedIn", "true");
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            applySettings();
            loadRecentRecords();
        } else { alert("Password incorrect."); }
    }
    function logout() {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦é–å®šæ‡‰ç”¨ç¨‹å¼å—ï¼Ÿ")) {
            localStorage.removeItem("isLoggedIn");
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('loginPass').value = ''; 
        }
    }
    function openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
        renderConcernListSettings();
        renderMachineListSettings();
        const currentPass = localStorage.getItem("app_password");
        document.getElementById('set-password').placeholder = `Current: ${currentPass}`;
        document.getElementById('set-password').value = '';
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        const newPass = document.getElementById('set-password').value.trim();
        const newTimeout = parseFloat(document.getElementById('set-timeout').value);
        const newRatio = document.getElementById('set-ratio').value;
        const newLang = document.getElementById('set-lang').value;
        if (newPass) localStorage.setItem("app_password", newPass);
        if (!isNaN(newTimeout) && newTimeout > 0) localStorage.setItem("cfg_timeout", newTimeout);
        localStorage.setItem("cfg_ratio", newRatio);
        localStorage.setItem("cfg_lang", newLang);
        alert("è¨­å®šå·²å„²å­˜ï¼");
        closeSettings();
        applySettings();
    }
    function loadSettingsToUI() {
        document.getElementById('set-timeout').value = localStorage.getItem("cfg_timeout") || DEFAULT_VOICE_TIMEOUT;
        document.getElementById('set-ratio').value = localStorage.getItem("cfg_ratio") || '4/3';
        document.getElementById('set-lang').value = localStorage.getItem("cfg_lang") || 'cmn-Hant-TW';
    }
    function applySettings() {
        const ratio = localStorage.getItem("cfg_ratio") || '4/3';
        const container = document.getElementById('preview-container');
        container.className = ''; 
        container.classList.add(ratio === '4/3' ? 'ratio-4-3' : ratio === '16/9' ? 'ratio-16-9' : ratio === '9/16' ? 'ratio-9-16' : 'ratio-1-1');
        document.getElementById('ratio-display-tag').innerText = `Ratio: ${ratio.replace('/', ':')}`;
        document.getElementById('voice-lang-select').value = localStorage.getItem("cfg_lang") || 'cmn-Hant-TW';
    }
    function syncLanguage() {
        const lang = document.getElementById('set-lang').value;
        localStorage.setItem("cfg_lang", lang);
        document.getElementById('voice-lang-select').value = lang;
    }
    function getMachineList() { try { return JSON.parse(localStorage.getItem(MACHINE_LIST_KEY)) || DEFAULT_MACHINE_LIST; } catch (e) { return DEFAULT_MACHINE_LIST; } }
    function saveMachineList(list) { localStorage.setItem(MACHINE_LIST_KEY, JSON.stringify(list)); loadMachineListToUI(); renderMachineListSettings(); }
    function loadMachineListToUI() {
        const list = getMachineList();
        const select = document.getElementById('input-machine');
        select.innerHTML = '<option value="">-- Select Machine --</option>';
        list.forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; select.appendChild(option); });
    }
    function renderMachineListSettings() {
        const list = getMachineList();
        const container = document.getElementById('machine-list-container');
        container.innerHTML = '';
        list.forEach(item => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center'; div.style.padding = '5px 0';
            div.innerHTML = `<span>${item}</span><button type="button" onclick="removeMachine('${item}')" style="background: var(--danger-color); color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer;">&times;</button>`;
            container.appendChild(div);
        });
    }
    function addMachine() {
        const input = document.getElementById('new-machine-name');
        const newMachine = input.value.trim().toUpperCase();
        if (newMachine) { let list = getMachineList(); if (!list.includes(newMachine)) { list.push(newMachine); saveMachineList(list.sort()); } input.value = ''; }
    }
    function removeMachine(machine) { if (confirm(`ç¢ºå®šè¦ç§»é™¤æ©Ÿå°ï¼š${machine} å—?`)) { let list = getMachineList().filter(item => item !== machine); saveMachineList(list); } }
    function getConcernList() { try { return JSON.parse(localStorage.getItem(CONCERN_LIST_KEY)) || DEFAULT_CONCERN_LIST; } catch (e) { return DEFAULT_CONCERN_LIST; } }
    function saveConcernList(list) { localStorage.setItem(CONCERN_LIST_KEY, JSON.stringify(list)); loadConcernSectionToUI(); renderConcernListSettings(); }
    function loadConcernSectionToUI() {
        const list = getConcernList();
        const select = document.getElementById('input-concern-section');
        select.innerHTML = '<option value="">-- Select Section --</option>';
        list.forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; select.appendChild(option); });
    }
    function renderConcernListSettings() {
        const list = getConcernList();
        const container = document.getElementById('concern-section-list-container');
        container.innerHTML = '';
        list.forEach(item => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center'; div.style.padding = '5px 0';
            div.innerHTML = `<span>${item}</span><button type="button" onclick="removeConcernSection('${item}')" style="background: var(--danger-color); color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer;">&times;</button>`;
            container.appendChild(div);
        });
    }
    function addConcernSection() {
        const input = document.getElementById('new-concern-section');
        const newSection = input.value.trim();
        if (newSection) { let list = getConcernList(); if (!list.includes(newSection)) { list.push(newSection); saveConcernList(list.sort()); } input.value = ''; }
    }
    function removeConcernSection(section) { if (confirm(`ç¢ºå®šè¦ç§»é™¤éƒ¨é–€ï¼š${section} å—?`)) { let list = getConcernList().filter(item => item !== section); saveConcernList(list); } }
    function loadEmployeeID() { const employeeId = localStorage.getItem(EMPLOYEE_ID_KEY); if (employeeId) document.getElementById('input-employee-id').value = employeeId; }
    function saveEmployeeID() { const employeeId = document.getElementById('input-employee-id').value.trim(); if (employeeId) localStorage.setItem(EMPLOYEE_ID_KEY, employeeId); }


    // ================= è³‡æ–™å›å¡«èˆ‡æœ€è¿‘ç´€éŒ„é‚è¼¯ =================

    /**
     * è¼‰å…¥æœ€è¿‘çš„ NG ç´€éŒ„ä¸¦é¡¯ç¤ºåœ¨åº•éƒ¨åˆ—è¡¨ã€‚
     */
    function loadRecentRecords() {
        const listContainer = document.getElementById('recent-records-list');
        listContainer.innerHTML = '<p style="text-align: center; color: #999;"><div class="spinner" style="width: 20px; height: 20px;"></div> Loading...</p>';

        fetch(`${GAS_URL}?action=loadRecords`)
            .then(r => r.json())
            .then(res => {
                listContainer.innerHTML = '';
                if (res.result === 'success' && res.data.length > 0) {
                    res.data.forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'record-item';
                        item.setAttribute('onclick', `populateForm('${record.formNo}')`);
                        
                        // è³‡æ–™è™•ç†ï¼šå¦‚æœå¾Œç«¯æ²’çµ¦è³‡æ–™ï¼Œé¡¯ç¤º "-"
                        const stopTimeDisplayRaw = record.stopTime || "No Stop Time";
                        const machineDisplay = record.machine || 'N/A';
                        const formNoDisplay = record.formNo || 'N/A';
                        const concernDisplay = record.concernSection || 'N/A';
                        const startTimeDisplay = record.startTime ? `Start: ${record.startTime}` : '';

                        item.innerHTML = `
                            <div class="main-info-group">
                                <span class="form-no-display">#${formNoDisplay}</span>
                                <span class="stop-time-display">ğŸ›‘ ${stopTimeDisplayRaw}</span> 
                            </div>
                            <div class="details">
                                <div>${machineDisplay} (${concernDisplay})</div>
                                <div>${startTimeDisplay}</div>
                            </div>
                        `;
                        listContainer.appendChild(item);
                    });
                } else {
                    listContainer.innerHTML = '<p style="text-align: center; color: #999;">ç„¡æœ€è¿‘ç´€éŒ„ã€‚</p>';
                }
            })
            .catch(e => {
                console.error("Error loading recent records:", e);
                listContainer.innerHTML = '<p style="text-align: center; color: var(--danger-color);">âŒ è¼‰å…¥ç´€éŒ„å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– Apps Scriptã€‚</p>';
            });
    }

    /**
     * æ¸…é™¤æœ€è¿‘ç´€éŒ„åˆ—è¡¨ (é‡æ–°è¼‰å…¥)
     */
    function clearRecentRecords() {
        if(confirm("åˆ·æ–°åˆ—è¡¨ï¼Ÿ(é€™å°‡å¾é›²ç«¯é‡æ–°è®€å–æœ€æ–°è³‡æ–™)")) {
            loadRecentRecords();
        }
    }

    /**
     * æ ¹æ“š Repair Form No å¾é›²ç«¯ç²å–å®Œæ•´ç´€éŒ„ä¸¦å›å¡«è‡³è¡¨å–®ã€‚
     */
    function populateForm(formNo) {
        if (!confirm(`ç¢ºå®šè¦å°‡ Repair Form No [${formNo}] çš„è³‡æ–™å›å¡«è‡³è¡¨å–®å—ï¼Ÿ\n(é€™å°‡æœƒè¦†è“‹ç•¶å‰æ‰€æœ‰è¼¸å…¥å…§å®¹)`)) {
            return;
        }

        showStatus('loading', 'Loading Record...', `è¼‰å…¥å–®è™Ÿ ${formNo} çš„ç´€éŒ„...`);

        fetch(`${GAS_URL}?action=getRow&formNo=${encodeURIComponent(formNo)}`)
            .then(r => r.json())
            .then(res => {
                if (res.result === 'success') {
                    const data = res.data;
                    
                    processedImageBase64 = "";
                    document.getElementById('preview-img').src = "";
                    document.getElementById('preview-img').style.display = 'none';
                    document.querySelector('.placeholder').style.display = 'block';
                    applySettings(); 

                    document.getElementById('input-employee-id').value = data.employeeId;
                    document.getElementById('input-machine').value = data.machine;
                    document.getElementById('input-form-no').value = data.formNo;
                    document.getElementById('input-stop-time-full').value = data.stopTimeFull;
                    document.getElementById('input-start-time-full').value = data.startTimeFull;
                    document.getElementById('input-concern-section').value = data.concernSection;
                    document.getElementById('input-reason').value = data.reason;
                    document.getElementById('input-solution').value = data.solution;
                    document.getElementById('input-self-actions').value = data.selfActions;
                    
                    calculateTotalStopTime();

                    showStatus('success', 'Load Complete', `å–®è™Ÿ ${formNo} è³‡æ–™å·²å›å¡«ã€‚`);
                    setTimeout(() => { closeStatusModal(); }, 1500);

                } else {
                    showStatus('error', 'Load Failed', `è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼š${res.error}`);
                }
            })
            .catch(e => {
                console.error("Error populating form:", e);
                showStatus('error', 'Load Failed', 'ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚');
            });
    }

    // ================= æ™‚é–“è™•ç†å‡½æ•¸ (æœªä¿®æ”¹) =================
    const DATETIME_REGEX = /^(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})$/;
    function parseCustomDateTime(dtStr) {
        const match = dtStr.match(DATETIME_REGEX);
        if (!match) return null;
        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10) - 1; 
        const year = parseInt(match[3], 10);
        const hour = parseInt(match[4], 10);
        const minute = parseInt(match[5], 10);
        const date = new Date(year, month, day, hour, minute);
        if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null;
        return date;
    }
    function calculateTotalStopTime() {
        const stopTimeStr = document.getElementById('input-stop-time-full').value.trim();
        const startTimeStr = document.getElementById('input-start-time-full').value.trim();
        const totalTimeInput = document.getElementById('input-total-time');
        const unitSelect = document.getElementById('total-time-unit');
        const unit = unitSelect ? unitSelect.value : 'h';
        if (stopTimeStr === "" || startTimeStr === "") {
              totalTimeInput.value = ""; totalTimeInput.style.backgroundColor = '#eee'; totalTimeInput.dataset.diffMinutes = ''; return;
        }
        const stopDate = parseCustomDateTime(stopTimeStr);
        const startDate = parseCustomDateTime(startTimeStr);
        if (!stopDate || !startDate) {
            totalTimeInput.value = "Invalid Time"; totalTimeInput.style.backgroundColor = '#fff0f0'; totalTimeInput.dataset.diffMinutes = ''; return;
        }
        const diffMs = startDate.getTime() - stopDate.getTime();
        const diffMinutes = Math.round(diffMs / (1000 * 60)); 
        if (diffMinutes <= 0) {
            totalTimeInput.value = "0 min / 0.00 hr"; totalTimeInput.style.backgroundColor = '#fff0f0'; totalTimeInput.dataset.diffMinutes = 0; return;
        }
        totalTimeInput.dataset.diffMinutes = diffMinutes; 
        let totalTimeFormatted;
        if (unit === 'h') {
              const diffHours = diffMs / (1000 * 60 * 60);
              totalTimeFormatted = diffHours.toFixed(2) + " hr";
        } else {
              totalTimeFormatted = diffMinutes + " min";
        }
        totalTimeInput.value = totalTimeFormatted;
        totalTimeInput.style.backgroundColor = '#e6ffed';
    }
    function getFullDateTimeString(dateObj) {
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        const hour = String(dateObj.getHours()).padStart(2, '0');
        const minute = String(dateObj.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hour}:${minute}`;
    }
    function updateSingleTime(targetId) {
        const targetElement = document.getElementById(targetId);
        const fullDateTime = getFullDateTimeString(new Date());
        if (targetElement) { targetElement.value = fullDateTime; calculateTotalStopTime(); }
    }
    
    // ... (æª”æ¡ˆè™•ç†ã€èªéŸ³è™•ç†ã€å½ˆçª—ã€è¤‡è£½é€£çµã€å„²å­˜ä¸»å‡½æ•¸ä¿æŒä¸è®Š) ...
    // ç‚ºç¯€çœç©ºé–“ï¼Œè«‹ç¢ºä¿ä¸‹æ–¹å‡½æ•¸èˆ‡ä¹‹å‰ç‰ˆæœ¬ä¸€è‡´ï¼š
    // triggerFile, handleFile, processImageWithCanvas
    // toggleVoice, startVoice, manualStopVoice, resetVoiceUI
    // showStatus, closeStatusModal
    // copyFormattedInfo, viewExcel, viewDriveFolder
    // clearInputs, saveToCloud

    function triggerFile(id) { document.getElementById(id).click(); }
    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;
        showStatus('loading', 'Processing Photo...', 'åœ–ç‰‡è™•ç†ä¸­...');
        const reader = new FileReader();
        reader.onload = function(e) { const img = new Image(); img.onload = function() { processImageWithCanvas(img); }; img.src = e.target.result; };
        reader.readAsDataURL(file);
    }
    function processImageWithCanvas(img) {
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        const previewImg = document.getElementById('preview-img');
        const placeholder = document.querySelector('.placeholder');
        let width = img.width; let height = img.height;
        if (width > MAX_IMAGE_WIDTH) { height = Math.round(height * (MAX_IMAGE_WIDTH / width)); width = MAX_IMAGE_WIDTH; }
        canvas.width = width; canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        processedImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
        previewImg.src = processedImageBase64; previewImg.style.display = 'block'; placeholder.style.display = 'none';
        showStatus('success', 'Photo Ready', 'åœ–ç‰‡å·²å£“ç¸®ä¸¦æº–å‚™ä¸Šå‚³ã€‚'); setTimeout(() => { closeStatusModal(); }, 1000);
    }
    function toggleVoice(button) {
        if (!('webkitSpeechRecognition' in window)) { alert("æŠ±æ­‰ï¼Œä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ï¼ˆè«‹ä½¿ç”¨ Chrome ç€è¦½å™¨ï¼‰ã€‚"); return; }
        if (isRecording) { manualStopVoice(); } else { activeTextAreaId = button.dataset.target; startVoice(button); }
    }
    function startVoice(button) {
        isRecording = true; button.classList.add('recording'); button.innerHTML = 'ğŸ”´ éŒ„éŸ³ä¸­...';
        recognition = new webkitSpeechRecognition(); recognition.continuous = true; recognition.interimResults = true;
        recognition.lang = document.getElementById('voice-lang-select').value; 
        const targetElement = document.getElementById(activeTextAreaId); snapshotText = targetElement.value; 
        recognition.onstart = function() { clearTimeout(punctuationTimer); };
        recognition.onresult = function(event) {
            clearTimeout(punctuationTimer);
            let interimTranscript = ''; let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) { finalTranscript += event.results[i][0].transcript; } else { interimTranscript += event.results[i][0].transcript; }
            }
            targetElement.value = snapshotText + finalTranscript + interimTranscript;
            const timeout = parseFloat(localStorage.getItem("cfg_timeout") || DEFAULT_VOICE_TIMEOUT) * 1000;
            punctuationTimer = setTimeout(manualStopVoice, timeout);
        };
        recognition.onerror = function(event) { console.error('Recognition error: ' + event.error); resetVoiceUI(); if (event.error !== 'no-speech') alert('èªéŸ³è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤: ' + event.error); };
        recognition.onend = function() { if (isRecording) { resetVoiceUI(); } };
        try { recognition.start(); } catch(e) { console.warn("Recognition start failed."); }
    }
    function manualStopVoice() { if (recognition) { clearTimeout(punctuationTimer); recognition.stop(); const targetElement = document.getElementById(activeTextAreaId); snapshotText = targetElement.value; resetVoiceUI(); } }
    function resetVoiceUI() { isRecording = false; document.querySelectorAll('.btn-voice').forEach(button => { button.classList.remove('recording'); button.innerHTML = 'ğŸ¤ èªéŸ³è¼¸å…¥'; }); activeTextAreaId = null; }
    function showStatus(type, title, subtext) {
        const modal = document.getElementById('status-modal'); const spinner = document.getElementById('status-spinner'); const icon = document.getElementById('status-icon'); const closeBtn = document.getElementById('status-close-btn');
        document.getElementById('status-text').innerText = title; document.getElementById('status-subtext').innerText = subtext;
        spinner.style.display = (type === 'loading' ? 'block' : 'none'); icon.style.display = (type !== 'loading' ? 'block' : 'none'); closeBtn.style.display = (type !== 'loading' ? 'block' : 'none');
        icon.innerText = type === 'success' ? 'âœ…' : 'âŒ';
        modal.style.display = 'flex';
    }
    function closeStatusModal() { document.getElementById('status-modal').style.display = 'none'; }
    function copyFormattedInfo() {
        const machine = document.getElementById('input-machine').value; const formNo = document.getElementById('input-form-no').value; const stopTime = document.getElementById('input-stop-time-full').value; const startTime = document.getElementById('input-start-time-full').value; const totalTime = document.getElementById('input-total-time').value; const reason = document.getElementById('input-reason').value; const concernSection = document.getElementById('input-concern-section').value; const solution = document.getElementById('input-solution').value; const selfActions = document.getElementById('input-self-actions').value;
        if (!machine && !formNo && !reason) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™ï¼"); return; }
        let info = `ã€Machine NG ç´€éŒ„ã€‘\næ©Ÿå°: ${machine || '-'}\nç¶­ä¿®å–®è™Ÿ: ${formNo || '-'}\nåœæ©Ÿæ™‚é–“: ${stopTime || '-'}\né–‹æ©Ÿæ™‚é–“: ${startTime || '-'}\nç¸½è€—æ™‚: ${totalTime || 'N/A'}\nç›¸é—œéƒ¨é–€: ${concernSection || '-'}\nåŸå› : ${reason || '-'}\nè§£æ±ºæ–¹æ³•: ${solution || '-'}\nè‡ªæˆ‘è¡Œå‹•: ${selfActions || '-'}\n\n--- (è³‡æ–™å·²ä¸Šå‚³é›²ç«¯) ---`;
        navigator.clipboard.writeText(info).then(() => { showStatus('success', 'Copied!', 'è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚'); setTimeout(() => { closeStatusModal(); }, 1500); }).catch(err => { alert('ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚'); });
    }
    function viewExcel() { if (!FIXED_SHEET_ID) { alert("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š FIXED_SHEET_IDã€‚"); return; } window.open(`https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/edit`, '_blank'); }
    function viewDriveFolder() { if (!FIXED_FOLDER_ID) { alert("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š FIXED_FOLDER_IDã€‚"); return; } window.open(`https://drive.google.com/drive/folders/${FIXED_FOLDER_ID}`, '_blank'); }
    function clearInputs() {
        document.getElementById('input-machine').value = ""; document.getElementById('input-total-time').value = ""; document.getElementById('input-form-no').value = ""; document.getElementById('input-reason').value = ""; document.getElementById('input-concern-section').value = ""; document.getElementById('input-solution').value = ""; document.getElementById('input-self-actions').value = "";
        document.getElementById('input-stop-time-full').value = ""; document.getElementById('input-start-time-full').value = "";
        document.getElementById('input-total-time').style.backgroundColor = '#eee'; calculateTotalStopTime(); 
        processedImageBase64 = ""; document.getElementById('preview-img').src = ""; document.getElementById('preview-img').style.display = 'none'; document.querySelector('.placeholder').style.display = 'block'; applySettings();
    }
    function saveToCloud() {
        if(isRecording) manualStopVoice();
        const employeeId = document.getElementById('input-employee-id').value; const machine = document.getElementById('input-machine').value; const stopTimeFull = document.getElementById('input-stop-time-full').value; const startTimeFull = document.getElementById('input-start-time-full').value; const formNo = document.getElementById('input-form-no').value.trim().toUpperCase(); const reason = document.getElementById('input-reason').value; const concernSection = document.getElementById('input-concern-section').value; const solution = document.getElementById('input-solution').value; const selfActions = document.getElementById('input-self-actions').value;
        const stopDate = parseCustomDateTime(stopTimeFull); const startDate = parseCustomDateTime(startTimeFull);
        if (formNo === "") { alert("è«‹å¡«å¯« Repair Form No ä»¥ä¾¿è¿½è¹¤ã€‚"); return; }
        if (stopTimeFull && startTimeFull && (!stopDate || !startDate)) { alert("è«‹æª¢æŸ¥ Stop time (åœæ©Ÿæ™‚é–“) æˆ– Start time (é–‹æ©Ÿæ™‚é–“) æ ¼å¼æ˜¯å¦ç‚º DD/MM/YYYY hh:mmã€‚"); return; }
        if (stopDate && startDate && stopDate >= startDate) { alert("Start time (é–‹æ©Ÿæ™‚é–“) å¿…é ˆæ™šæ–¼ Stop time (åœæ©Ÿæ™‚é–“)ã€‚"); return; }
        if(!processedImageBase64 && !machine && !reason && !solution && !concernSection && !selfActions) { alert("Empty! Please fill in machine info/notes or take a photo."); return; }
        if (machine.trim() === "") { alert("è«‹é¸æ“‡ Machine (æ©Ÿå°)ã€‚"); return; }
        saveEmployeeID();
        const scriptUrl = GAS_URL; const btn = document.getElementById('saveBtn');
        btn.disabled = true; showStatus('loading', 'Uploading...', 'è³‡æ–™ä¸Šå‚³ä¸­...');
        const data = { image: processedImageBase64, employeeId: employeeId, machine: machine, stopTimeFull: stopTimeFull, startTimeFull: startTimeFull, formNo: formNo, reason: reason, concernSection: concernSection, solution: solution, selfActions: selfActions, folderId: FIXED_FOLDER_ID };
        fetch(scriptUrl, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json()).then(res => {
            const action = res.action || 'æ–°å¢'; 
            if (res.result === 'success') { showStatus('success', 'Upload Success!', `è³‡æ–™å·²æˆåŠŸ ${action}ï¼`); clearInputs(); loadRecentRecords(); setTimeout(() => { closeStatusModal(); }, 2000); } 
            else { showStatus('error', 'Upload Failed', `ä¸Šå‚³å¤±æ•—ï¼š${res.error || 'æœªçŸ¥çš„éŒ¯èª¤ã€‚'}`); }
        }).catch(e => { console.error(e); showStatus('error', 'Upload Failed', 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ã€‚'); }).finally(() => { btn.disabled = false; });
    }
</script>

</body>
</html>
